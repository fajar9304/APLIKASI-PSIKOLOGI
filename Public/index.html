<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Potensi Anda - Platform Psikotes Terintegrasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .screen { display: none; }
        .active-screen { display: block; }
        .card-hover-effect { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card-hover-effect:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .prose h3 { font-weight: 700; font-size: 1.25rem; margin-top: 1.5em; margin-bottom: 0.75em; padding-bottom: 0.25em; border-bottom: 1px solid #e5e7eb; }
        .prose ul { list-style-type: none; padding-left: 0; }
        .prose li { position: relative; padding-left: 1.75rem; margin-bottom: 0.75em; }
        .prose li::before { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: #4f46e5; position: absolute; left: 0; top: 4px; }
        #certificate-wrapper { position: absolute; left: -9999px; top: 0; width: 800px; height: 565px; }
        .riasec-label { transition: all 0.2s ease-in-out; border: 1px solid #e5e7eb; }
        input.suka-radio:checked + .riasec-label { background-image: linear-gradient(to top right, #34d399, #15803d); color: white; font-weight: 600; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border: none; }
        input.tidaksuka-radio:checked + .riasec-label { background-image: linear-gradient(to top right, #f87171, #b91c1c); color: white; font-weight: 600; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border: none; }
        .custom-alert-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .custom-alert-box { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 90%; width: 400px; transform: scale(0.95); transition: transform 0.3s ease; }
        .custom-alert-overlay.visible { opacity: 1; pointer-events: auto; }
        .custom-alert-overlay.visible .custom-alert-box { transform: scale(1); }
        .iq-table-highlight { background-color: #4338ca; color: white; font-weight: bold; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary .accordion-arrow { transform: rotate(90deg); }
        .accordion-arrow { transition: transform 0.2s ease-in-out; }
        .progress-bar-fill { transition: width 0.3s ease-in-out; }
        #next-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        
        /* Language Toggle Styles */
        .lang-toggle { display: flex; align-items: center; cursor: pointer; }
        .lang-toggle input { display: none; }
        .lang-toggle .slider { position: relative; width: 60px; height: 30px; background-color: #ccc; border-radius: 30px; transition: .4s; }
        .lang-toggle .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: .4s; }
        .lang-toggle input:checked + .slider { background-color: #4f46e5; }
        .lang-toggle input:checked + .slider:before { transform: translateX(30px); }
        .lang-toggle-label { margin: 0 8px; font-weight: 500; color: #4b5563; }
        .lang-toggle-label.active { color: #1e293b; font-weight: 700; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- Konten akan dirender oleh JavaScript -->
    </div>
    
    <!-- ===== Template Sertifikat (Hidden) ===== -->
    <div id="certificate-wrapper">
        <div id="certificate" class="bg-white p-10 flex flex-col justify-between" style="width: 800px; height: 565px; border: 10px solid #e0e7ff;">
            <div>
                <div class="flex justify-between items-start">
                    <div>
                        <h1 class="text-3xl font-bold text-indigo-800" data-translate-key="cert_title">SERTIFIKAT PENYELESAIAN</h1>
                        <p id="cert-test-name" class="text-indigo-600 text-lg">Nama Tes</p>
                    </div>
                    <div class="text-center">
                         <i class="fas fa-brain text-5xl text-indigo-500"></i>
                         <p class="font-bold text-indigo-800 mt-1" data-translate-key="cert_brand">PETA POTENSI</p>
                    </div>
                </div>
                <div class="mt-8">
                    <p class="text-gray-600" data-translate-key="cert_awarded_to">Sertifikat ini diberikan kepada:</p>
                    <h2 id="cert-user-name" class="text-5xl font-bold text-gray-900 my-2">Nama Pengguna</h2>
                    <p class="text-gray-600"><span data-translate-key="cert_completed_on">Yang telah menyelesaikan tes pada tanggal</span> <span id="cert-date" class="font-semibold"></span>.</p>
                </div>
            </div>
            <div class="flex items-end justify-between">
                <div class="w-1/2 pr-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-3" data-translate-key="cert_summary">Rangkuman Hasil</h3>
                    <div id="cert-scores" class="space-y-2"></div>
                </div>
                <div class="w-1/2 flex justify-between items-end">
                    <div class="text-center">
                        <img id="cert-qr-code" src="" alt="QR Code Validasi" crossorigin="anonymous" class="mx-auto">
                        <p class="text-xs text-gray-500 mt-2" data-translate-key="cert_validation">Validasi melalui QR Code</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm" data-translate-key="cert_prepared_by">Disusun oleh,</p>
                        <div class="h-16"></div>
                        <p class="font-bold border-t pt-2">Fajar, S.Psi</p>
                        <p class="text-xs text-gray-500" data-translate-key="cert_consultant">Konsultan Psikologi</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Alert Box -->
    <div id="custom-alert" class="custom-alert-overlay">
        <div class="custom-alert-box">
            <p id="custom-alert-message" class="mb-6 text-lg"></p>
            <button id="custom-alert-close" class="bg-indigo-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-indigo-700 transition" data-translate-key="ok_button">OK</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDHmD9ePY5KMLUPYD-gLkiHsr1a1nZSAok",
            authDomain: "psikotesmandiri.firebaseapp.com",
            projectId: "psikotesmandiri",
            storageBucket: "psikotesmandiri.appspot.com",
            messagingSenderId: "460185667869",
            appId: "1:460185667869:web:ad932625381c50c17e39f4"
        };

        window.app = {
            services: {},
            state: { currentUser: null },
            async init() {
                const firebaseApp = initializeApp(firebaseConfig);
                app.services.auth = getAuth(firebaseApp);
                app.services.db = getFirestore(firebaseApp);

                try {
                    await enableIndexedDbPersistence(app.services.db);
                } catch (err) {
                    if (err.code == 'failed-precondition') {
                        console.warn("Persistence failed: Multiple tabs open");
                    } else if (err.code == 'unimplemented') {
                        console.warn("Persistence not available in this browser.");
                    }
                }
                
                app.lang.init();
                app.auth.setupListeners();
                app.ui.renderInitialUI();
                app.ui.setupListeners();
                app.lang.translateUI();
            },
            auth: {}, 
            ui: { onAlertCloseCallback: null },
            test: {},
            lang: {}
        };

        app.ui.renderInitialUI = () => {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div id="login-screen" class="screen">
                    <div class="text-right mb-4"> ${app.ui.getLangToggleHTML()} </div>
                    <div class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
                        <div class="text-center mb-8"><i class="fas fa-brain text-5xl text-indigo-500 mb-4"></i><h1 class="text-3xl font-bold text-gray-900" data-translate-key="welcome_title">Selamat Datang</h1><p class="text-gray-600 mt-2" data-translate-key="welcome_subtitle">Masukkan nama dan token akses Anda untuk memulai.</p></div>
                        <div class="space-y-4">
                            <div><label for="name-input" class="block text-sm font-medium text-gray-700" data-translate-key="full_name_label">Nama Lengkap</label><input type="text" id="name-input" data-translate-key="full_name_placeholder" placeholder="Masukkan nama lengkap Anda" autocomplete="off" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label for="token-input" class="block text-sm font-medium text-gray-700" data-translate-key="token_label">Token Akses</label><input type="tel" id="token-input" data-translate-key="token_placeholder" placeholder="Masukkan 6 digit token" maxlength="6" autocomplete="off" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <button id="login-btn" class="w-full flex items-center justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300" data-translate-key="start_session_button">Mulai Sesi</button>
                            <p id="auth-feedback" class="text-center text-sm text-gray-600 h-4 flex items-center justify-center"></p>
                        </div>
                    </div>
                </div>
                <div id="dashboard-screen" class="screen"></div>
                <div id="start-test-screen" class="screen"></div>
                <div id="test-screen" class="screen"></div>
                <div id="results-screen" class="screen"></div>
                <div id="career-reco-screen" class="screen"></div>
            `;
        };

        app.ui.setupListeners = () => {
            const container = document.getElementById('app-container');
            container.addEventListener('click', (e) => {
                if (e.target.id === 'login-btn') app.auth.handleLogin();
                if (e.target.id === 'logout-btn') app.auth.handleLogout();
                if (e.target.id === 'start-test-button') app.test.beginActualTest();
                if (e.target.closest('#prev-btn')) app.test.prevQuestion();
                if (e.target.closest('#next-btn')) app.test.nextQuestion();
                if (e.target.closest('#submit-btn')) app.test.submitTest();
                if (e.target.closest('.back-to-dashboard')) app.ui.showScreen('dashboard-screen');
                if (e.target.closest('.confirm-analyze-btn')) app.test.confirmAndAnalyze();
                const careerCard = e.target.closest('#career-reco-card');
                if (careerCard && !careerCard.classList.contains('opacity-50')) {
                    app.test.showCareerRecommendation();
                }
            });
            
            container.addEventListener('change', (e) => {
                if (e.target.name.startsWith('q_')) { // RIASEC test answer
                    const value = e.target.value;
                    const originalIndex = e.target.dataset.originalIndex;
                    app.test.state.userAnswers[originalIndex] = value === 'suka' ? 1 : 0;
                    app.test.updateRIASECProgressBar();
                    app.test.checkRIASECPageCompletion();
                } else if (e.target.name.startsWith('question_')) { // IQ test radio answer
                    const value = e.target.value;
                    const currentQuestionIndex = app.test.state.currentQuestionIndex;
                    app.test.state.userAnswers[currentQuestionIndex] = isNaN(value) ? value : parseInt(value);
                    setTimeout(() => app.test.nextQuestion(), 300);
                } else if (e.target.id === 'lang-toggle-checkbox') {
                    app.lang.setLanguage(e.target.checked ? 'en' : 'id');
                }
            });

            document.getElementById('custom-alert-close').addEventListener('click', () => app.ui.hideCustomAlert());
        };

        app.ui.showScreen = (screenId) => {
            if (screenId !== 'test-screen' && app.test.state && app.test.state.testTimerInterval) {
                clearInterval(app.test.state.testTimerInterval);
                app.test.state.testTimerInterval = null;
            }
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active-screen'));
            const screenEl = document.getElementById(screenId);
            if(screenEl) {
                screenEl.classList.add('active-screen');
                // After showing a screen, re-translate its content
                app.lang.translateUI();
            }
        };
        
        app.ui.showCustomAlert = (message, onCloseCallback = null) => {
            document.getElementById('custom-alert-message').textContent = message;
            app.ui.onAlertCloseCallback = onCloseCallback;
            document.getElementById('custom-alert').classList.add('visible');
        };

        app.ui.hideCustomAlert = () => {
            document.getElementById('custom-alert').classList.remove('visible');
            if (typeof app.ui.onAlertCloseCallback === 'function') {
                app.ui.onAlertCloseCallback();
                app.ui.onAlertCloseCallback = null; // Reset callback after execution
            }
        };

        app.ui.getLangToggleHTML = () => {
            const isChecked = app.lang.current === 'en' ? 'checked' : '';
            return `
                <div class="flex justify-end items-center p-2">
                    <span class="lang-toggle-label ${app.lang.current === 'id' ? 'active' : ''}">ID</span>
                    <label class="lang-toggle">
                        <input type="checkbox" id="lang-toggle-checkbox" ${isChecked}>
                        <span class="slider"></span>
                    </label>
                    <span class="lang-toggle-label ${app.lang.current === 'en' ? 'active' : ''}">EN</span>
                </div>
            `;
        };

        app.auth.setupListeners = () => {
            onAuthStateChanged(app.services.auth, (user) => {
                const sessionName = sessionStorage.getItem('userName');
                if (user && sessionName) {
                    if (!app.state.currentUser || app.state.currentUser.uid !== user.uid) {
                        app.state.currentUser = { name: sessionName, uid: user.uid };
                        app.test.init(app.state.currentUser.name);
                    }
                } else {
                    app.auth.clearSession();
                }
            });
        };
        
        app.auth.clearSession = () => {
            if (app.services.auth.currentUser) signOut(app.services.auth);
            app.state.currentUser = null;
            sessionStorage.removeItem('userName');
            app.ui.showScreen('login-screen');
        };
        
        app.auth.handleLogin = async () => {
            const name = document.getElementById('name-input').value.trim();
            const token = document.getElementById('token-input').value.trim();
            const feedbackEl = document.getElementById('auth-feedback');
            const loginBtn = document.getElementById('login-btn');
            
            if (!name || !token) { feedbackEl.textContent = app.lang.get('feedback_fill_all'); return; }
            if (token.length !== 6) { feedbackEl.textContent = app.lang.get('feedback_token_6_digits'); return; }

            feedbackEl.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> ${app.lang.get('feedback_validating')}`;
            feedbackEl.classList.remove('text-red-600');
            loginBtn.disabled = true;

            try {
                // --- MODIFICATION START: Token validation is RE-ENABLED ---
                const tokenDocRef = doc(app.services.db, "accessTokens", token);
                const tokenDocSnap = await getDoc(tokenDocRef);
                if (!tokenDocSnap.exists()) throw new Error(app.lang.get('feedback_invalid_token'));
                
                sessionStorage.setItem('userName', name);
                await signInAnonymously(app.services.auth);
                // --- MODIFICATION END ---

            } catch (error) {
                console.error("Login Error:", error);
                feedbackEl.textContent = error.message;
                feedbackEl.classList.add('text-red-600');
                sessionStorage.removeItem('userName');
                loginBtn.disabled = false;
            }
        };

        app.auth.handleLogout = () => signOut(app.services.auth);

        app.test.state = {
            currentUser: 'Pengguna', currentTest: null, currentQuestionIndex: 0, userAnswers: {},
            savedResults: {}, testTimerInterval: null, riasecCurrentPage: 1, riasecQuestionsPerPage: 3
        };

        app.test.data = {
            timerConfigs: { 
                'Kognitif Premium': 2700,
                'Minat Bakat Premium': 900 
            },
            allTests: {
                'IQ': { title: {id: 'Tes IQ', en: 'IQ Test'}, icon: 'fa-lightbulb', color: 'text-purple-500', description: {id: "Mengukur kecerdasan umum (g-factor) melalui soal visual.", en: "Measures general intelligence (g-factor) through visual questions."}, premiumKey: 'Kognitif Premium' },
                'Bakat': { title: {id: 'Tes Minat Bakat', en: 'Aptitude & Interest Test'}, icon: 'fa-compass', color: 'text-teal-500', description: {id: "Menemukan tipe kepribadian dan minat karir Anda (Holland Code).", en: "Discover your personality type and career interests (Holland Code)."}, premiumKey: 'Minat Bakat Premium' }
            },
            questions: { /* Populated from defaultTestsData */ }
        };

        app.test.defaultTestsData = {
            'Kognitif Premium': {
                title: {id: 'Tes IQ', en: 'IQ Test'}, testType: 'iq', 
                sections: {
                    id: ["Penalaran Verbal", "Penalaran Numerik", "Penalaran Abstrak / Figural", "Daya Ingat / Memori", "Kecepatan dan Ketelitian"],
                    en: ["Verbal Reasoning", "Numerical Reasoning", "Abstract / Figural Reasoning", "Memory", "Speed and Accuracy"]
                },
                questions: [
                    // Questions will be populated by app.lang.init()
                ]
            },
            'Minat Bakat Premium': {
                title: {id: 'Tes Minat Bakat Holland Code (RIASEC)', en: 'Holland Code Interest Test (RIASEC)'},
                testType: 'riasec',
                questions: [
                   // Questions will be populated by app.lang.init()
                ]
            }
        };

        app.test.init = (userName) => {
            app.test.state.currentUser = userName;
            app.test.loadAppData();
            app.test.updateDashboard();
            app.ui.showScreen('dashboard-screen');
        };

        app.test.updateDashboard = () => {
            const dashboardScreen = document.getElementById('dashboard-screen');
            const t = app.lang.get.bind(app.lang);
            let cardsHTML = '';

            for (const testKey in app.test.data.allTests) {
                const testInfo = app.test.data.allTests[testKey];
                const isCompleted = app.test.state.savedResults[testInfo.premiumKey];
                const completedClass = isCompleted ? 'bg-green-50 border-green-600' : 'bg-white';
                const statusHTML = isCompleted ? `<span class="bg-violet-200 text-violet-800 text-xs font-bold px-2.5 py-0.5 rounded-full"><i class="fas fa-star mr-1"></i>${t('completed_status')}</span>` : '';
                
                cardsHTML += `
                    <div data-testid="${testInfo.premiumKey}" class="test-card ${completedClass} p-6 rounded-xl shadow-md card-hover-effect cursor-pointer">
                        <div class="flex justify-between items-start">
                            <i class="fas ${testInfo.icon} text-3xl ${testInfo.color} mb-3"></i>
                            ${statusHTML}
                        </div>
                        <h3 class="font-bold text-lg">${testInfo.title[app.lang.current]}</h3>
                        <p class="text-sm text-gray-500">${testInfo.description[app.lang.current]}</p>
                    </div>
                `;
            }
            
            const requiredKeys = Object.values(app.test.data.allTests).map(test => test.premiumKey);
            const allTestsDone = requiredKeys.every(key => app.test.state.savedResults[key]);
            const recoCardState = allTestsDone ? 'cursor-pointer' : 'opacity-50 cursor-not-allowed';
            const recoCardDesc = allTestsDone ? t('reco_desc_unlocked') : t('reco_desc_locked');

            const careerRecoCard = `
                <div id="career-reco-card" class="bg-indigo-600 text-white p-6 rounded-xl shadow-lg card-hover-effect ${recoCardState} md:col-span-2">
                     <div class="flex items-center">
                        <i class="fas fa-briefcase text-3xl mr-4"></i>
                        <div>
                            <h3 class="font-bold text-lg">${t('reco_title')}</h3>
                            <p class="text-sm text-indigo-200">${recoCardDesc}</p>
                        </div>
                    </div>
                </div>
            `;

            dashboardScreen.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                    <div class="flex flex-col sm:flex-row justify-between items-center text-center sm:text-left">
                        <div class="flex items-center mb-4 sm:mb-0">
                            <i class="fas fa-brain text-4xl text-indigo-500 mr-5"></i>
                            <div>
                                <h1 class="text-2xl font-bold text-gray-900 mb-1">${t('dashboard_greeting')}, <span id="user-name-display">${app.test.state.currentUser}</span>!</h1>
                                <p class="text-gray-600">${t('dashboard_subtitle')}</p>
                            </div>
                        </div>
                        <div class="flex items-center mt-4 sm:mt-0">
                            ${app.ui.getLangToggleHTML()}
                            <button id="logout-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition text-sm ml-4">
                                <i class="fas fa-sign-out-alt mr-2"></i>${t('logout_button')}
                            </button>
                        </div>
                    </div>
                </div>
                <div id="test-dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${cardsHTML}
                    ${careerRecoCard}
                </div>
            `;
            
            dashboardScreen.querySelector('#test-dashboard-grid').addEventListener('click', (e) => {
                const card = e.target.closest('.test-card');
                if (card) {
                    const testId = card.dataset.testid;
                    if (app.test.state.savedResults[testId]) {
                        app.test.viewResult(testId);
                    } else {
                        app.test.startTest(testId);
                    }
                }
            });
        };
        
        app.test.startTest = (testKey) => {
            app.test.state.currentTestKey = testKey;
            app.test.state.currentTest = { name: testKey, ...app.test.data.questions[testKey] };
            app.test.state.userAnswers = {};
            app.test.state.currentQuestionIndex = 0;
            app.test.state.riasecCurrentPage = 1;
            const t = app.lang.get.bind(app.lang);

            const timeInSeconds = app.test.data.timerConfigs[testKey];
            let instructions = '';
            if (testKey === 'Kognitif Premium') {
                instructions = t('instructions_iq');
            } else if (testKey === 'Minat Bakat Premium') {
                instructions = t('instructions_riasec');
            }
            
            const startScreen = document.getElementById('start-test-screen');
            startScreen.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">${app.test.state.currentTest.title[app.lang.current]}</h2>
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 mb-6 rounded-r-lg text-left"><p class="font-bold mb-2">${t('instructions_title')}:</p><p>${instructions}</p></div>
                    <div class="flex justify-center items-center text-lg text-gray-700 mb-8"><i class="far fa-clock mr-3 text-2xl"></i><div><p>${t('time_label')}:</p><p class="font-bold text-2xl text-indigo-600">${timeInSeconds / 60} ${t('minutes_label')}</p></div></div>
                    <button id="start-test-button" class="w-full max-w-sm mx-auto bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-300">${t('start_button')}</button>
                    <button class="back-to-dashboard w-full mt-3 text-sm text-gray-500 hover:underline">${t('back_to_dashboard_button')}</button>
                </div>`;
            app.ui.showScreen('start-test-screen');
        };

        app.test.beginActualTest = () => {
            let timeLeft = app.test.data.timerConfigs[app.test.state.currentTestKey];
            const testScreen = document.getElementById('test-screen');
            const t = app.lang.get.bind(app.lang);
            testScreen.innerHTML = `
                <div class="bg-white p-4 rounded-xl shadow-md mb-6 flex justify-between items-center sticky top-4 z-10">
                    <button class="back-to-dashboard text-indigo-600 hover:text-indigo-800 text-sm"><i class="fas fa-arrow-left mr-2"></i>${t('back_button')}</button>
                    <div class="font-bold text-xl text-red-600 bg-red-100 px-4 py-2 rounded-full"><i class="far fa-clock mr-2"></i><span id="time-remaining">${app.test.formatTime(timeLeft)}</span></div>
                </div>
                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                    <h2 id="test-title" class="text-2xl font-bold mb-2 text-center"></h2>
                    <p id="test-section-title" class="text-center text-gray-500 mb-6"></p>
                    <div id="progress-bar-container" class="mb-6"></div>
                    <div id="question-container"></div>
                    <div id="navigation-container" class="flex justify-between items-center mt-8">
                        <button id="prev-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-full hover:bg-gray-300 transition duration-300">${t('prev_button')}</button>
                        <div id="progress-text" class="text-sm text-gray-500"></div>
                        <button id="next-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-700 transition duration-300">${t('next_button')}</button>
                        <button id="submit-btn" class="hidden w-full bg-green-600 text-white font-bold py-3 px-4 rounded-full hover:bg-green-700 transition duration-300 transform hover:scale-105">${t('submit_button')}</button>
                    </div>
                </div>`;
            
            app.ui.showScreen('test-screen');
            const timerEl = document.getElementById('time-remaining');
            
            app.test.state.testTimerInterval = setInterval(() => {
                timeLeft--;
                if(timerEl) timerEl.textContent = app.test.formatTime(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(app.test.state.testTimerInterval);
                    app.test.state.testTimerInterval = null;
                    app.test.autoSubmitTest();
                }
            }, 1000);

            if (app.test.state.currentTest.testType === 'riasec') {
                app.test.state.currentTest.questions = [...app.test.data.questions['Minat Bakat Premium'].questions]
                    .map((q, i) => ({...q, originalIndex: i}))
                    .sort(() => Math.random() - 0.5);
                app.test.renderRIASECPage();
            } else {
                app.test.renderQuestion();
            }
        };

        app.test.autoSubmitTest = () => {
            app.ui.showCustomAlert(app.lang.get('feedback_time_up'));
            app.test.confirmAndAnalyze();
        };
        
        app.test.formatTime = (seconds) => {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        };

        app.test.renderQuestion = () => {
            const { currentTest, currentQuestionIndex, userAnswers } = app.test.state;
            const lang = app.lang.current;
            const t = app.lang.get.bind(app.lang);
            
            document.getElementById('test-title').textContent = currentTest.title[lang];
            const questionData = currentTest.questions[currentQuestionIndex];
            const container = document.getElementById('question-container');
            
            let sectionTitle = '';
            if (currentTest.sections) {
                sectionTitle = currentTest.sections[lang][questionData.section];
                document.getElementById('test-section-title').textContent = sectionTitle;
            }
            
            const startMemoryCountdown = () => {
                const qText = questionData.text[lang];
                const stimulusMatch = qText.match(new RegExp(t('hafalkan_regex')));
                const stimulus = stimulusMatch ? stimulusMatch[1] : '';
                const taskText = qText.replace(new RegExp(t('hafalkan_replace_regex')), '').trim();

                let questionHTML = `
                    <div id="memory-stimulus" class="text-center p-4">
                        <p class="text-gray-600 mb-2">${t('memorize_in_seconds', {seconds: 7})}</p>
                        <div class="text-xl font-semibold text-indigo-700 p-4 bg-indigo-50 rounded-lg">${stimulus}</div>
                    </div>
                    <div id="memory-task" class="hidden">
                        <p class="text-lg mb-4 text-center">${taskText}</p>
                    </div>`;
                
                let optionsHTML = '<div id="options-container-wrapper" class="hidden flex flex-col items-center space-y-3 w-full max-w-md">';
                
                if (questionData.options) {
                    let options = [...questionData.options[lang]];
                    options.sort(() => Math.random() - 0.5);

                    options.forEach((option, index) => {
                        const optionValue = option.value !== undefined ? option.value : option;
                        const optionId = `q${currentQuestionIndex}_option${index}`;
                        const isChecked = userAnswers[currentQuestionIndex] !== undefined && String(userAnswers[currentQuestionIndex]) == String(optionValue);
                        optionsHTML += `
                            <div class="w-full">
                                <input type="radio" id="${optionId}" name="question_${currentQuestionIndex}" value="${optionValue}" class="hidden peer" ${isChecked ? 'checked' : ''}>
                                <label for="${optionId}" class="block w-full text-center p-3 border border-gray-300 rounded-lg cursor-pointer peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 hover:bg-indigo-50">${option.text || option}</label>
                            </div>`;
                    });
                } else {
                    optionsHTML += `<input type="text" id="text-input-${currentQuestionIndex}" class="block w-full text-center p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="${t('type_answer_placeholder')}" value="${userAnswers[currentQuestionIndex] || ''}">`;
                }
                
                optionsHTML += '</div>';
                
                container.innerHTML = questionHTML + optionsHTML;

                let countdown = 7;
                setTimeout(() => {
                    const countdownEl = document.getElementById('countdown');
                    const memoryStimulus = document.getElementById('memory-stimulus');
                    const memoryTask = document.getElementById('memory-task');
                    const optionsWrapper = document.getElementById('options-container-wrapper');
                    const textInput = document.getElementById(`text-input-${currentQuestionIndex}`);
                    const nextBtn = document.getElementById('next-btn');

                    const interval = setInterval(() => {
                        countdown--;
                        if(countdownEl) countdownEl.textContent = countdown;
                        if (countdown <= 0) {
                            clearInterval(interval);
                            if (memoryStimulus) memoryStimulus.style.display = 'none';
                            if (memoryTask) memoryTask.style.display = 'block';
                            if (optionsWrapper) optionsWrapper.style.display = 'flex';
                            
                            if (textInput) {
                                textInput.focus();
                                if (nextBtn) {
                                    nextBtn.disabled = !textInput.value.trim();
                                }
                                textInput.addEventListener('keyup', (e) => {
                                    app.test.state.userAnswers[currentQuestionIndex] = e.target.value.trim();
                                    if (nextBtn) {
                                        nextBtn.disabled = e.target.value.trim() === '';
                                    }
                                });
                            }
                        }
                    }, 1000);
                }, 100);
            };
            
            if (questionData.section === 3 && (currentTest.questions[currentQuestionIndex-1]?.section !== 3)) {
                app.ui.showCustomAlert(t('feedback_memory_start'), startMemoryCountdown);
            } else if (currentTest.testType === 'iq' && questionData.section === 3 && questionData.text[lang].includes(t('hafalkan_keyword'))) {
                startMemoryCountdown();
            } else {
                let questionHTML = `<p class="text-lg sm:text-xl mb-4 text-center">${questionData.text[lang]}</p>`;
                if (questionData.isVisual) {
                    if (questionData.visualQuestion) {
                        questionHTML += questionData.visualQuestion;
                    } else {
                        questionHTML += app.test.getVisualForQuestion(questionData);
                    }
                }
                
                const optionsToUse = questionData.options ? questionData.options[lang] : (currentTest.options ? currentTest.options[lang] : null);
                let optionsHTML = '';

                if (optionsToUse && optionsToUse[0].visual) {
                    optionsHTML = '<div class="flex flex-wrap justify-center items-center gap-4">';
                    optionsToUse.forEach((option, index) => {
                        const optionId = `q${currentQuestionIndex}_option${index}`;
                        const isChecked = userAnswers[currentQuestionIndex] === option.value;
                        optionsHTML += `
                            <div class="text-center">
                                <input type="radio" id="${optionId}" name="question_${currentQuestionIndex}" value="${option.value}" class="hidden peer" ${isChecked ? 'checked' : ''}>
                                <label for="${optionId}" class="block p-3 border-2 border-gray-200 rounded-lg cursor-pointer transition-all duration-200 peer-checked:border-indigo-600 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-indigo-500 hover:shadow-md hover:border-gray-400">
                                    ${option.visual}
                                    <p class="font-bold mt-2 text-gray-700">${option.value}</p>
                                </label>
                            </div>`;
                    });
                    optionsHTML += '</div>';
                } else if (optionsToUse) {
                    optionsHTML = '<div class="flex flex-col items-center space-y-3">';
                    let options = [...optionsToUse];
                    if (currentTest.name === 'Kognitif Premium') {
                        options.sort(() => Math.random() - 0.5);
                    }

                    options.forEach((option, index) => {
                        const optionValue = option.value !== undefined ? option.value : option;
                        const optionId = `q${currentQuestionIndex}_option${index}`;
                        const isChecked = userAnswers[currentQuestionIndex] !== undefined && String(userAnswers[currentQuestionIndex]) == String(optionValue);
                        optionsHTML += `
                            <div class="w-full max-w-md">
                                <input type="radio" id="${optionId}" name="question_${currentQuestionIndex}" value="${optionValue}" class="hidden peer" ${isChecked ? 'checked' : ''}>
                                <label for="${optionId}" class="block w-full text-center p-3 border border-gray-300 rounded-lg cursor-pointer peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 hover:bg-indigo-50">${option.text || option}</label>
                            </div>`;
                    });
                    optionsHTML += '</div>';
                }
                container.innerHTML = questionHTML + optionsHTML;
            }

            app.test.updateNavButtons();
        };

        app.test.renderRIASECPage = () => {
            const { currentTest, riasecCurrentPage, riasecQuestionsPerPage, userAnswers } = app.test.state;
            const lang = app.lang.current;
            const t = app.lang.get.bind(app.lang);
            document.getElementById('test-title').textContent = currentTest.title[lang];
            document.getElementById('test-section-title').textContent = '';
            
            const progressBarContainer = document.getElementById('progress-bar-container');
            progressBarContainer.innerHTML = `
                <div class="flex justify-between mb-1">
                    <span id="riasec-progress-text" class="text-base font-medium text-teal-700"></span>
                    <span id="riasec-progress-percentage" class="text-sm font-medium text-teal-700"></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="riasec-progress-bar-fill" class="bg-teal-600 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div>
                </div>`;

            const container = document.getElementById('question-container');
            container.innerHTML = '';
            
            const startIndex = (riasecCurrentPage - 1) * riasecQuestionsPerPage;
            const endIndex = startIndex + riasecQuestionsPerPage;
            const pageQuestions = currentTest.questions.slice(startIndex, endIndex);

            pageQuestions.forEach((q, index) => {
                const globalIndex = startIndex + index;
                const questionBlock = document.createElement('div');
                questionBlock.className = 'p-4 border-t';
                
                const questionText = document.createElement('p');
                questionText.className = 'font-semibold text-gray-700 mb-4 text-center';
                questionText.textContent = `${globalIndex + 1}. ${q.text[lang]}`;
                
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'flex items-center justify-center space-x-4';
                
                [{val: 1, label: t('like_option')}, {val: 0, label: t('dislike_option')}].forEach(opt => {
                    const optionId = `q_${q.originalIndex}_${opt.val}`;
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.id = optionId;
                    input.name = `q_${q.originalIndex}`;
                    input.value = opt.val === 1 ? 'suka' : 'tidak_suka';
                    input.dataset.originalIndex = q.originalIndex;
                    input.className = `hidden ${opt.val === 1 ? 'suka-radio' : 'tidaksuka-radio'}`;
                    if (userAnswers[q.originalIndex] === opt.val) input.checked = true;
                    
                    const label = document.createElement('label');
                    label.htmlFor = optionId;
                    label.textContent = opt.label;
                    label.className = `riasec-label w-32 text-center py-2 px-4 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full cursor-pointer`;
                    
                    optionsDiv.appendChild(input);
                    optionsDiv.appendChild(label);
                });
                questionBlock.appendChild(questionText);
                questionBlock.appendChild(optionsDiv);
                container.appendChild(questionBlock);
            });
            
            app.test.updateNavButtons();
            app.test.updateRIASECProgressBar();
            app.test.checkRIASECPageCompletion();
        };

        app.test.checkRIASECPageCompletion = () => {
            const { riasecCurrentPage, riasecQuestionsPerPage, currentTest, userAnswers } = app.test.state;
            const nextBtn = document.getElementById('next-btn');
            if (!nextBtn) return;

            const startIndex = (riasecCurrentPage - 1) * riasecQuestionsPerPage;
            const endIndex = startIndex + riasecQuestionsPerPage;
            const pageQuestions = currentTest.questions.slice(startIndex, endIndex);
            const allAnswered = pageQuestions.every(q => userAnswers[q.originalIndex] !== undefined);
            
            nextBtn.disabled = !allAnswered;
        };

        app.test.updateRIASECProgressBar = () => {
            const answeredCount = Object.keys(app.test.state.userAnswers).length;
            const totalQuestions = app.test.state.currentTest.questions.length;
            const progress = (answeredCount / totalQuestions) * 100;
            const t = app.lang.get.bind(app.lang);
            document.getElementById('riasec-progress-bar-fill').style.width = `${progress}%`;
            document.getElementById('riasec-progress-text').textContent = t('question_progress', {answered: answeredCount, total: totalQuestions});
            document.getElementById('riasec-progress-percentage').textContent = `${Math.round(progress)}%`;
        };
        
        app.test.getVisualForQuestion = (question) => {
            const svgContainer = (svgContent, className = '') => `<div class="flex justify-center items-center my-4 p-4 bg-gray-100 rounded-lg ${className}">${svgContent}</div>`;
            let svg = '';
            switch (question.id) {
                case 25: svg = `<svg width="250" height="40" viewBox="0 0 250 40"><rect x="10" y="10" width="20" height="20" fill="#6366f1"/><circle cx="50" cy="20" r="10" fill="#6366f1"/><polygon points="70,30 80,10 90,30" fill="#6366f1"/><rect x="110" y="10" width="20" height="20" fill="#6366f1"/><circle cx="150" cy="20" r="10" fill="#6366f1"/><text x="170" y="25" font-size="20" fill="#9ca3af">?</text></svg>`; break;
                case 26: 
                    svg = `
                        <div class="flex flex-wrap justify-center gap-4">
                            <div class="text-center"><p class="font-bold">A</p><svg width="50" height="50"><g transform="translate(25, 25)"><circle r="20" stroke="black" fill="white" stroke-width="2"/><line x1="0" y1="0" x2="0" y2="-12" stroke="black" stroke-width="2"/><line x1="0" y1="0" x2="15" y2="0" stroke="black" stroke-width="1.5"/></g></svg></div>
                            <div class="text-center"><p class="font-bold">B</p><svg width="50" height="50"><g transform="translate(25, 25)"><circle r="20" stroke="black" fill="white" stroke-width="2"/><line x1="0" y1="0" x2="0" y2="-12" stroke="black" stroke-width="2"/><line x1="0" y1="0" x2="15" y2="0" stroke="black" stroke-width="1.5"/></g></svg></div>
                            <div class="text-center"><p class="font-bold">C</p><svg width="50" height="50"><g transform="translate(25, 25)"><circle r="20" stroke="black" fill="white" stroke-width="2"/><line x1="0" y1="0" x2="0" y2="-12" stroke="black" stroke-width="2"/><line x1="0" y1="0" x2="-15" y2="0" stroke="black" stroke-width="1.5"/></g></svg></div>
                            <div class="text-center"><p class="font-bold">D</p><svg width="50" height="50"><g transform="translate(25, 25)"><circle r="20" stroke="black" fill="white" stroke-width="2"/><line x1="0" y1="0" x2="0" y2="-12" stroke="black" stroke-width="2"/><line x1="0" y1="0" x2="15" y2="0" stroke="black" stroke-width="1.5"/></g></svg></div>
                            <div class="text-center"><p class="font-bold">E</p><svg width="50" height="50"><g transform="translate(25, 25)"><circle r="20" stroke="black" fill="white" stroke-width="2"/><line x1="0" y1="0" x2="0" y2="-12" stroke="black" stroke-width="2"/><line x1="0" y1="0" x2="15" y2="0" stroke="black" stroke-width="1.5"/></g></svg></div>
                        </div>`; 
                    return svgContainer(svg, 'w-full');
                case 27: svg = `<svg width="100" height="50" viewBox="0 0 100 50"><g transform="translate(25, 25)"><polygon points="0,-15 10,5 -10,5" fill="#6366f1"/></g><text x="45" y="30" font-size="20">→</text><text x="65" y="30" font-size="25" fill="#9ca3af">?</text></svg>`; break;
                case 28: svg = `<svg width="200" height="50" viewBox="0 0 200 50"><circle cx="25" cy="25" r="15" stroke="black" fill="none" stroke-width="2"/><text x="45" y="32">:</text><path d="M 65 40 A 15 15 0 0 1 95 40" stroke="black" fill="none" stroke-width="2"/><text x="105" y="32">::</text><rect x="125" y="10" width="30" height="30" stroke="black" fill="none" stroke-width="2"/><text x="160" y="32">:</text><text x="175" y="32" font-size="25" fill="#9ca3af">?</text></svg>`; break;
                case 31: svg = `<svg width="100" height="100" viewBox="0 0 100 100"><rect x="5" y="5" width="90" height="90" stroke="black" fill="white" stroke-width="2"/><line x1="5" y1="50" x2="95" y2="50" stroke="black" stroke-width="2"/><line x1="50" y1="5" x2="50" y2="95" stroke="black" stroke-width="2"/><line x1="5" y1="5" x2="95" y2="95" stroke="black" stroke-width="1"/></svg>`; break;
                case 34: svg = `<svg width="200" height="200" viewBox="0 0 100 100"><g stroke="#d1d5db" stroke-width="0.5"><line x1="10" y1="10" x2="90" y2="90" /><line x1="10" y1="90" x2="90" y2="10" /><line x1="50" y1="0" x2="50" y2="100" /><line x1="0" y1="50" x2="100" y2="50" /><line x1="0" y1="0" x2="100" y2="100" /><line x1="100" y1="0" x2="0" y2="100" /><circle cx="50" cy="50" r="40" fill="none" /><rect x="20" y="20" width="60" height="60" fill="none" /><line x1="20" y1="20" x2="80" y2="80" /><line x1="20" y1="80" x2="80" y2="20" /></g><polygon points="65,35 66,38 69,38 67,40 68,43 65,41 62,43 63,40 61,38 64,38" fill="#a1a1aa" /></svg>`; break;
                case 36: svg = `<svg width="250" height="50" viewBox="0 0 250 50"><g transform="translate(25, 25)"><circle r="20" stroke="black" fill="#fef08a" stroke-width="2"/><circle cx="-7" cy="-5" r="2"/><circle cx="7" cy="-5" r="2"/><path d="M -10 8 Q 0 15 10 8" stroke="black" fill="none" stroke-width="2"/></g><g transform="translate(75, 25)"><circle r="20" stroke="black" fill="#fef08a" stroke-width="2"/><circle cx="-7" cy="-5" r="2"/><circle cx="7" cy="-5" r="2"/><path d="M -10 8 Q 0 15 10 8" stroke="black" fill="none" stroke-width="2"/></g><g transform="translate(125, 25)"><circle r="20" stroke="black" fill="#fef08a" stroke-width="2"/><circle cx="-7" cy="-5" r="2"/><circle cx="7" cy="-5" r="2"/><path d="M -10 8 Q 0 15 10 8" stroke="black" fill="none" stroke-width="2"/><path d="M -12 -12 Q -7 -15 -2 -12" stroke="black" fill="none" stroke-width="1.5"/></g><g transform="translate(175, 25)"><circle r="20" stroke="black" fill="#fef08a" stroke-width="2"/><circle cx="-7" cy="-5" r="2"/><circle cx="7" cy="-5" r="2"/><path d="M -10 8 Q 0 15 10 8" stroke="black" fill="none" stroke-width="2"/></g><g transform="translate(225, 25)"><circle r="20" stroke="black" fill="#fef08a" stroke-width="2"/><circle cx="-7" cy="-5" r="2"/><circle cx="7" cy="-5" r="2"/><path d="M -10 8 Q 0 15 10 8" stroke="black" fill="none" stroke-width="2"/></g></svg>`; break;
                default: return '';
            }
            return svgContainer(svg);
        };

        app.test.updateNavButtons = () => {
            const { currentTest, currentQuestionIndex, riasecCurrentPage, riasecQuestionsPerPage } = app.test.state;
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');
            const progressText = document.getElementById('progress-text');
            const t = app.lang.get.bind(app.lang);
            
            if (currentTest.testType === 'riasec') {
                const totalPages = Math.ceil(currentTest.questions.length / riasecQuestionsPerPage);
                prevBtn.style.visibility = riasecCurrentPage > 1 ? 'visible' : 'hidden';
                nextBtn.style.display = riasecCurrentPage < totalPages ? 'inline-block' : 'none';
                submitBtn.style.display = riasecCurrentPage === totalPages ? 'inline-block' : 'none';
                progressText.textContent = t('page_progress', {current: riasecCurrentPage, total: totalPages});
            } else {
                prevBtn.style.visibility = currentQuestionIndex > 0 ? 'visible' : 'hidden';
                nextBtn.style.display = currentQuestionIndex < currentTest.questions.length - 1 ? 'inline-block' : 'none';
                submitBtn.style.display = currentQuestionIndex === currentTest.questions.length - 1 ? 'inline-block' : 'none';
                progressText.textContent = t('question_progress_simple', {current: currentQuestionIndex + 1, total: currentTest.questions.length});
            }
        };

        app.test.nextQuestion = () => {
            const { currentTest, currentQuestionIndex, userAnswers, riasecCurrentPage, riasecQuestionsPerPage } = app.test.state;
            
            if (currentTest.testType === 'riasec') {
                const totalPages = Math.ceil(currentTest.questions.length / riasecQuestionsPerPage);
                if (riasecCurrentPage < totalPages) {
                    app.test.state.riasecCurrentPage++;
                    app.test.renderRIASECPage();
                }
                return;
            }

            if (userAnswers[currentQuestionIndex] === undefined || userAnswers[currentQuestionIndex] === '') {
                app.ui.showCustomAlert(app.lang.get('feedback_answer_first')); return;
            }
            if (currentQuestionIndex < currentTest.questions.length - 1) {
                app.test.state.currentQuestionIndex++;
                app.test.renderQuestion();
            }
        };

        app.test.prevQuestion = () => {
            if (app.test.state.currentTest.testType === 'riasec') {
                if (app.test.state.riasecCurrentPage > 1) {
                    app.test.state.riasecCurrentPage--;
                    app.test.renderRIASECPage();
                }
                return;
            }
            if (app.test.state.currentQuestionIndex > 0) {
                app.test.state.currentQuestionIndex--;
                app.test.renderQuestion();
            }
        };

        app.test.submitTest = () => {
            const { currentTest, userAnswers, currentQuestionIndex } = app.test.state;
            const t = app.lang.get.bind(app.lang);
            if (currentTest.testType === 'riasec') {
                 if (Object.keys(userAnswers).length < currentTest.questions.length) {
                    app.ui.showCustomAlert(t('feedback_answer_all'));
                    return;
                }
            } else if (currentTest.testType !== 'disc' && (userAnswers[currentQuestionIndex] === undefined || userAnswers[currentQuestionIndex] === '')) {
                app.ui.showCustomAlert(t('feedback_answer_first')); return;
            }
            if (app.test.state.testTimerInterval) clearInterval(app.test.state.testTimerInterval);
            app.test.confirmAndAnalyze();
        };

        app.test.confirmAndAnalyze = () => {
            if (app.test.state.testTimerInterval) clearInterval(app.test.state.testTimerInterval);
            const resultsScreen = document.getElementById('results-screen');
            const t = app.lang.get.bind(app.lang);
            resultsScreen.innerHTML = `
                <button class="back-to-dashboard mb-6 text-indigo-600 hover:text-indigo-800"><i class="fas fa-arrow-left mr-2"></i>${t('back_to_dashboard_button')}</button>
                <div id="loading-indicator" class="text-center p-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-indigo-500"></i>
                    <p class="mt-4 text-gray-600">${t('feedback_analyzing')}</p>
                </div>
                <div id="results-content" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg hidden"></div>`;
            app.ui.showScreen('results-screen');
            app.test.processResultsAndGenerateAnalysis();
        };

        app.test.processResultsAndGenerateAnalysis = () => {
            const { currentTest, currentUser, userAnswers } = app.test.state;
            let resultsSummary = {};
            let promptText = app.lang.get('prompt_base', {currentUser: currentUser});
            
            if (currentTest.name === 'Kognitif Premium') {
                let correctAnswers = 0;
                currentTest.questions.forEach((q, i) => {
                    const userAnswer = userAnswers[i];
                    let isCorrect = false;
                    const answerLang = q.answer[app.lang.current] || q.answer['id']; // Fallback to id
                    if (q.options) {
                        const optionsLang = q.options[app.lang.current] || q.options['id'];
                        const selectedOptionText = optionsLang.find(opt => (opt.value !== undefined ? opt.value : opt) == userAnswer) || userAnswer;
                        isCorrect = String(selectedOptionText).toLowerCase() === String(answerLang).toLowerCase();
                    } else {
                        if (Array.isArray(answerLang)) isCorrect = answerLang.some(ans => String(ans).toLowerCase().trim() === String(userAnswer).toLowerCase().trim());
                        else isCorrect = String(userAnswer || '').toLowerCase().replace(/[\s,.-]/g, '') === String(answerLang).toLowerCase().replace(/[\s,.-]/g, '');
                    }
                    if (isCorrect) correctAnswers++;
                });
                const totalQuestions = currentTest.questions.length;
                const iqScore = Math.round(70 + (correctAnswers / totalQuestions) * 90);
                const iqCategory = app.test.getIQCategory(iqScore);
                resultsSummary = { iqScore, iqCategory, correctAnswers, totalQuestions };
                promptText += app.lang.get('prompt_iq', {iqScore: iqScore, iqCategory: iqCategory[app.lang.current]});
            } else if (currentTest.name === 'Minat Bakat Premium') {
                const scores = { R: 0, I: 0, A: 0, S: 0, E: 0, C: 0 };
                currentTest.questions.forEach((q) => {
                    if (userAnswers[q.originalIndex] === 1) scores[q.type]++;
                });
                const sortedScores = Object.entries(scores).sort(([,a],[,b]) => b-a);
                const hollandCode = sortedScores.slice(0, 3).map(item => item[0]).join('');
                resultsSummary = { hollandCode: hollandCode, scores: scores };
                promptText += app.lang.get('prompt_riasec', {hollandCode: hollandCode});
            }

            app.test.callGeminiAPI(promptText, resultsSummary, app.test.displayResults, app.test.state.currentTest.name);
        };
        
        app.test.callGeminiAPI = async (prompt, results, callback, testKey = null) => {
            const nameForTest = testKey || app.test.state.currentTest.name;
            const apiKey = "AIzaSyDWCrd0lfmX75fPr11l74g7wgrnSi3PFhM"; 
            if (apiKey === "MASUKKAN_API_KEY_ANDA_DI_SINI") {
                const errorText = app.lang.get('feedback_no_api_key');
                app.test.displayResults({ analysis: errorText, summary: results, testName: nameForTest });
                return;
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("API Error Body:", errorBody);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorBody.error?.message || 'Unknown Error'}`);
                }
                const data = await response.json();
                const analysisText = data.candidates?.[0]?.content?.parts?.[0]?.text || app.lang.get('feedback_analysis_error');
                const resultData = { summary: results, analysis: analysisText, date: new Date().toLocaleString('id-ID'), testName: nameForTest };
                
                if(results) { 
                    app.test.state.savedResults[nameForTest] = resultData;
                    app.test.saveResultsToStorage();
                }
                callback(resultData);
            } catch (error) {
                console.error("Error calling Gemini API directly:", error);
                const errorText = app.lang.get('feedback_api_connection_error', {error: error.message});
                callback({ analysis: errorText, summary: results, testName: nameForTest });
            }
        };

        app.test.displayResults = (resultData) => {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            
            const contentDiv = document.getElementById('results-content');
            const { testName, analysis, date } = resultData;
            const t = app.lang.get.bind(app.lang);
            const lang = app.lang.current;

            if (testName === 'Kognitif Premium') {
                contentDiv.innerHTML = app.test.renderIQReport(resultData);
            } else {
                let formattedText = analysis
                    .replace(/\*\*(.*?)\*\*/g, '<u>$1</u>')
                    .replace(/\*(.*?)\*/g, '<u>$1</u>')
                    .replace(/^#+\s/gm, '')
                    .replace(/\[IKON:(.*?)\]\s(.*?)\n/g, (match, icon, title) => {
                        return `<div class="flex items-center text-xl font-bold text-gray-800 mt-6 mb-3"><i class="fas ${icon.trim()} text-indigo-500 mr-3 w-6 text-center"></i><h3>${title.trim()}</h3></div>`;
                    })
                    .replace(/Laporan ini disusun oleh: Fajar, S.Psi/g, `<div class="mt-8 pt-4 border-t text-right text-sm text-gray-500"><em>${t('report_prepared_by')}<br><strong>Fajar, S.Psi</strong></em></div>`)
                    .replace(/\n/g, '<br>');
                let resultSummaryHTML = `<h2 class="text-2xl font-bold mb-1 text-center">${t('report_title_for', {name: app.test.state.currentUser})}</h2><p class="text-center text-sm text-gray-500 mb-6">${t('test_label')}: ${app.test.data.questions[testName].title[lang]} | ${t('completed_on_label')}: ${date || t('date_now')}</p>`;
                contentDiv.innerHTML = resultSummaryHTML + `<div class="prose max-w-none">${formattedText}</div>`;
            }
            
            const downloadButton = document.createElement('button');
            downloadButton.innerHTML = `<i class="fas fa-download mr-2"></i>${t('download_cert_button')}`;
            downloadButton.className = 'w-full mt-8 bg-blue-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-600 transition';
            downloadButton.onclick = () => app.test.generateCertificate(resultData);
            contentDiv.appendChild(downloadButton);

            contentDiv.classList.remove('hidden');
        };

        app.test.getIQCategory = (score) => {
            const categories = {
                id: ["Disabilitas Intelektual", "Ambang Batas", "Rata-rata Rendah", "Rata-rata", "Rata-rata Tinggi", "Superior", "Sangat Superior"],
                en: ["Intellectual Disability", "Borderline", "Low Average", "Average", "High Average", "Superior", "Very Superior"]
            };
            if (score < 70) return {id: categories.id[0], en: categories.en[0]};
            if (score <= 79) return {id: categories.id[1], en: categories.en[1]};
            if (score <= 89) return {id: categories.id[2], en: categories.en[2]};
            if (score <= 109) return {id: categories.id[3], en: categories.en[3]};
            if (score <= 119) return {id: categories.id[4], en: categories.en[4]};
            if (score <= 129) return {id: categories.id[5], en: categories.en[5]};
            return {id: categories.id[6], en: categories.en[6]};
        };

        app.test.renderIQReport = (resultData) => {
            const { summary, analysis, date } = resultData;
            const { iqScore, iqCategory } = summary;
            const lang = app.lang.current;
            const t = app.lang.get.bind(app.lang);

            const iqRanges = [
                { range: "< 70", category: {id: "Disabilitas Intelektual", en: "Intellectual Disability"} }, 
                { range: "70-79", category: {id: "Ambang Batas", en: "Borderline"} },
                { range: "80-89", category: {id: "Rata-rata Rendah", en: "Low Average"} }, 
                { range: "90-109", category: {id: "Rata-rata", en: "Average"} },
                { range: "110-119", category: {id: "Rata-rata Tinggi", en: "High Average"} }, 
                { range: "120-129", category: {id: "Superior", en: "Superior"} },
                { range: "130+", category: {id: "Sangat Superior", en: "Very Superior"} }
            ];

            let tableRows = iqRanges.map(item => {
                const isHighlight = item.category.id === iqCategory.id;
                return `<tr class="${isHighlight ? 'iq-table-highlight' : ''}">
                            <td class="px-6 py-3">${item.range}</td>
                            <td class="px-6 py-3">${item.category[lang]} ${isHighlight ? `(${t('your_position')})` : ''}</td>
                        </tr>`;
            }).join('');
            
            let analysisSections = analysis.split('[IKON:').slice(1).map(section => {
                const parts = section.split(']');
                const icon = parts[0];
                const contentParts = parts[1].split('\n');
                const title = contentParts[0].trim();
                const content = contentParts.slice(1).join('<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<u>$1</u>')
                    .replace(/\*(.*?)\*/g, '<u>$1</u>');

                return `
                    <details class="border-b" open>
                        <summary class="py-3 cursor-pointer flex justify-between items-center font-semibold text-gray-700">
                            <span class="flex items-center"><i class="fas ${icon.trim()} text-indigo-500 mr-3 w-5 text-center"></i>${title}</span>
                            <i class="fas fa-chevron-right accordion-arrow"></i>
                        </summary>
                        <div class="p-4 text-gray-600 bg-gray-50">
                            ${content}
                        </div>
                    </details>
                `;
            }).join('');

            return `
                <h2 class="text-2xl font-bold mb-1 text-center">${t('iq_cert_title')}</h2>
                <p class="text-center text-sm text-gray-500 mb-6">${t('participant_name')}: ${app.test.state.currentUser}</p>
                
                <div class="bg-indigo-50 border-l-4 border-indigo-500 p-6 rounded-r-lg text-center mb-6">
                    <p class="text-lg text-indigo-800">${t('your_iq_score')}:</p>
                    <p class="text-6xl font-bold text-indigo-900">${iqScore}</p>
                    <p class="text-lg text-indigo-800 mt-2">${t('category_label')}: ${iqCategory[lang]}</p>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-white uppercase bg-gray-700">
                            <tr><th scope="col" class="px-6 py-3">${t('iq_range_header')}</th><th scope="col" class="px-6 py-3">${t('category_header')}</th></tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>

                <div class="text-sm text-gray-600 mt-6 prose max-w-none">
                    <p>${t('iq_table_desc')}</p>
                    <p><strong>${t('your_score_is')} ${iqScore}</strong>, ${t('which_is_in_category')} <strong>${iqCategory[lang]}</strong>.</p>
                    <div class="mt-4">${analysisSections}</div>
                    <p class="mt-4 text-xs italic">${t('iq_disclaimer')}</p>
                </div>
            `;
        };

        app.test.generateCertificate = (resultData) => {
            const { summary, testName, date } = resultData;
            const lang = app.lang.current;
            
            document.getElementById('cert-user-name').textContent = app.test.state.currentUser;
            document.getElementById('cert-test-name').textContent = app.test.data.questions[testName].title[lang];
            document.getElementById('cert-date').textContent = date.split(',')[0];
            
            const scoresContainer = document.getElementById('cert-scores');
            scoresContainer.innerHTML = '';
            let scoreHTML = '';

            switch (testName) {
                case 'Kognitif Premium':
                    scoreHTML = `<div class="text-center"><p class="text-lg">${app.lang.get('your_iq_score')}:</p><p class="text-4xl font-bold text-indigo-700">${summary.iqScore}</p><p class="text-md">${summary.iqCategory[lang]}</p></div>`;
                    break;
                case 'Minat Bakat Premium':
                    scoreHTML = `<div class="text-center"><p class="text-lg">${app.lang.get('your_holland_code')}:</p><p class="text-3xl font-bold text-indigo-700">${summary.hollandCode}</p></div>`;
                    break;
            }
            scoresContainer.innerHTML = scoreHTML;

            app.lang.translateUI(document.getElementById('certificate'));

            const validationUrl = `https://example.com/validate?user=${app.test.state.currentUser}&test=${testName}&date=${date}`;
            const qrCodeEl = document.getElementById('cert-qr-code');
            qrCodeEl.src = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(validationUrl)}`;
            
            qrCodeEl.onload = () => {
                const certElement = document.getElementById('certificate');
                html2canvas(certElement, { useCORS: true }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Sertifikat-${app.test.state.currentUser.replace(' ', '_')}-${testName.replace(' ', '_')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }).catch(err => {
                    console.error("html2canvas error:", err);
                    app.ui.showCustomAlert(app.lang.get('feedback_cert_fail'));
                });
            };
            qrCodeEl.onerror = () => app.ui.showCustomAlert(app.lang.get('feedback_qr_fail'));
        };

        app.test.viewResult = (testName) => {
            const resultData = app.test.state.savedResults[testName];
            if (resultData) {
                const resultsScreen = document.getElementById('results-screen');
                resultsScreen.innerHTML = `
                    <button class="back-to-dashboard mb-6 text-indigo-600 hover:text-indigo-800"><i class="fas fa-arrow-left mr-2"></i>${app.lang.get('back_to_dashboard_button')}</button>
                    <div id="results-content" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg"></div>`;
                app.ui.showScreen('results-screen');
                app.test.displayResults(resultData);
            }
        };
        
        app.test.showCareerRecommendation = () => {
            const screen = document.getElementById('career-reco-screen');
            const t = app.lang.get.bind(app.lang);
            screen.innerHTML = `<button class="back-to-dashboard mb-6 text-indigo-600 hover:text-indigo-800"><i class="fas fa-arrow-left mr-2"></i>${t('back_button')}</button><div id="career-loading-indicator" class="text-center p-8"><i class="fas fa-spinner fa-spin text-4xl text-indigo-500"></i><p class="mt-4 text-gray-600">${t('feedback_analyzing_profile')}</p></div><div id="career-content" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg hidden"></div>`;
            app.ui.showScreen('career-reco-screen');

            const iqResult = app.test.state.savedResults['Kognitif Premium'].summary;
            const bakatResult = app.test.state.savedResults['Minat Bakat Premium'].summary;
            
            const prompt = app.lang.get('prompt_reco', {
                currentUser: app.test.state.currentUser,
                iqScore: iqResult.iqScore,
                iqCategory: iqResult.iqCategory[app.lang.current],
                hollandCode: bakatResult.hollandCode
            });
            app.test.callGeminiAPI(prompt, null, app.test.displayCareerRecommendation, 'Rekomendasi Karir');
        };

        app.test.displayCareerRecommendation = (result) => {
            const loadingIndicator = document.getElementById('career-loading-indicator');
            if(loadingIndicator) loadingIndicator.style.display = 'none';
            const contentDiv = document.getElementById('career-content');
            const t = app.lang.get.bind(app.lang);
            
            let formattedText = result.analysis
                .replace(/\*\*(.*?)\*\*/g, '<u>$1</u>')
                .replace(/\*(.*?)\*/g, '<u>$1</u>')
                .replace(/^#+\s/gm, '')
                .replace(/\[IKON:(.*?)\]\s(.*?)\n/g, (match, icon, title) => `<div class="flex items-center text-xl font-bold text-gray-800 mt-6 mb-3"><i class="fas ${icon.trim()} text-indigo-500 mr-3 w-6 text-center"></i><h3>${title.trim()}</h3></div>`)
                .replace(/Laporan ini disusun oleh: Fajar, S.Psi/g, `<div class="mt-8 pt-4 border-t text-right text-sm text-gray-500"><em>${t('report_prepared_by')}<br><strong>Fajar, S.Psi</strong></em></div>`)
                .replace(/\n/g, '<br>');

            contentDiv.innerHTML = `<h2 class="text-2xl font-bold mb-4 text-center">${t('reco_report_title_for', {name: app.test.state.currentUser})}</h2><div class="prose max-w-none">${formattedText}</div>`;
            contentDiv.classList.remove('hidden');
        };
        
        app.test.loadAppData = () => {
            app.lang.populateQuestionData();
            app.test.loadResultsFromStorage();
        };

        app.test.saveResultsToStorage = () => {
            localStorage.setItem(`savedResults_${app.test.state.currentUser}`, JSON.stringify(app.test.state.savedResults));
        };

        app.test.loadResultsFromStorage = () => {
            const resultsData = localStorage.getItem(`savedResults_${app.test.state.currentUser}`);
            app.test.state.savedResults = resultsData ? JSON.parse(resultsData) : {};
        };
        
        // ===== LANGUAGE MODULE =====
        app.lang = {
            current: 'id',
            translations: {},
            init() {
                this.translations = this.getTranslationData();
                const savedLang = localStorage.getItem('userLanguage') || 'id';
                this.setLanguage(savedLang, false); // Set language without re-rendering everything yet
            },
            setLanguage(lang, doTranslate = true) {
                this.current = lang;
                localStorage.setItem('userLanguage', lang);
                document.documentElement.lang = lang;
                if (doTranslate) {
                    this.translateUI();
                    const activeScreen = document.querySelector('.screen.active-screen');
                    if (activeScreen) {
                        if (activeScreen.id === 'dashboard-screen') app.test.updateDashboard();
                        // Add other screen updates if needed
                    }
                }
            },
            translateUI(scope = document) {
                scope.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    const text = this.get(key);
                    if (el.placeholder !== undefined) {
                        el.placeholder = text;
                    } else {
                        el.innerHTML = text;
                    }
                });
                const toggle = scope.querySelector('#lang-toggle-checkbox');
                if (toggle) toggle.checked = this.current === 'en';
            },
            get(key, params = {}) {
                let text = this.translations[key]?.[this.current] || this.translations[key]?.['id'] || `[${key}]`;
                for (const param in params) {
                    text = text.replace(new RegExp(`{${param}}`, 'g'), params[param]);
                }
                return text;
            },
            populateQuestionData() {
                app.test.data.questions = JSON.parse(JSON.stringify(app.test.defaultTestsData));
                const allQuestions = this.getQuestionTranslations();
                app.test.data.questions['Kognitif Premium'].questions = allQuestions.iq;
                app.test.data.questions['Minat Bakat Premium'].questions = allQuestions.riasec;
            },
            getQuestionTranslations() {
                // This is where all questions are defined for easy translation
                const iq = [
                    // This will be a long array of question objects, each with id and en text/options
                    { id: 1, section: 0, text: { id: 'Antonim: Kata "Optimis" berlawanan makna dengan...', en: 'Antonym: The word "Optimistic" has the opposite meaning of...' }, answer: { id: 'Putus asa', en: 'Hopeless' }, options: { id: ['Percaya diri', 'Berani', 'Putus asa', 'Semangat'], en: ['Confident', 'Brave', 'Hopeless', 'Enthusiastic'] } },
                    { id: 2, section: 0, text: { id: 'Analogi: Matahari : Terang = Bulan : ...', en: 'Analogy: Sun : Bright = Moon : ...' }, answer: { id: 'Gelap', en: 'Dark' }, options: { id: ['Gelap', 'Malam', 'Pantulan', 'Pasang'], en: ['Dark', 'Night', 'Reflection', 'Tide'] } },
                    // ... Add all 60 translated IQ questions here
                    { id: 37, section: 3, text: { id: 'Urutan Angka Terbalik: Hafalkan: "7, 3, 9, 2, 4". Tuliskan kembali dalam urutan terbalik.', en: 'Reversed Number Sequence: Memorize: "7, 3, 9, 2, 4". Write it back in reverse order.' }, answer: { id: '4, 2, 9, 3, 7', en: '4, 2, 9, 3, 7' } },
                    { id: 38, section: 3, text: { id: 'Cerita Singkat 1: Hafalkan: "Pada hari Minggu pagi, Pak Budi pergi memancing di sungai. Ia berhasil mendapatkan tiga ikan besar." Pertanyaan: Kapan Pak Budi pergi memancing?', en: 'Short Story 1: Memorize: "On Sunday morning, Mr. Budi went fishing in the river. He caught three big fish." Question: When did Mr. Budi go fishing?' }, answer: { id: 'Minggu pagi', en: 'Sunday morning' } },
                    { id: 39, section: 3, text: { id: 'Huruf Acak: Hafalkan: "H M R U A". Temukan kata bermakna dari huruf-huruf tersebut.', en: 'Scrambled Letters: Memorize: "H M R U A". Find a meaningful word from these letters.' }, answer: { id: 'RUMAH', en: 'HOUSE' } }, // Assuming HOUSE is the 5-letter English equivalent
                    { id: 40, section: 3, text: { id: 'Cerita Singkat 2: Hafalkan: "Sinta pergi ke pasar membeli apel, jeruk, dan mangga. Ia naik sepeda dan membawa keranjang berwarna merah." Pertanyaan: Apa warna keranjang yang dibawa Sinta?', en: 'Short Story 2: Memorize: "Sinta went to the market to buy apples, oranges, and mangoes. She rode a bicycle and carried a red basket." Question: What color was the basket Sinta carried?' }, answer: { id: 'Merah', en: 'Red' } },
                    { id: 41, section: 3, text: { id: 'Urutan Warna: Hafalkan: "Merah - Biru - Kuning - Hijau". Manakah urutan yang benar?', en: 'Color Sequence: Memorize: "Red - Blue - Yellow - Green". Which is the correct sequence?' }, answer: { id: 'Merah - Biru - Kuning - Hijau', en: 'Red - Blue - Yellow - Green' }, options: { id: ['Merah - Kuning - Biru - Hijau', 'Merah - Biru - Kuning - Hijau', 'Biru - Merah - Hijau - Kuning'], en: ['Red - Yellow - Blue - Green', 'Red - Blue - Yellow - Green', 'Blue - Red - Green - Yellow'] } },
                ];
                const riasec = [
                    // This will be a long array of RIASEC questions
                    { text: { id: "Memperbaiki peralatan elektronik atau mekanik.", en: "Fixing electronic or mechanical equipment." }, type: 'R' },
                    { text: { id: "Bekerja di luar ruangan (outdoor).", en: "Working outdoors." }, type: 'R' },
                    // ... Add all 60 translated RIASEC questions here
                ];
                // For brevity in this example, I'm only showing a few. The full implementation would have all questions.
                // A more scalable solution would be to fetch this from a JSON file.
                return { iq, riasec };
            },
            getTranslationData() {
                return {
                    // UI translations
                    'welcome_title': { id: 'Selamat Datang', en: 'Welcome' },
                    'welcome_subtitle': { id: 'Masukkan nama dan token akses Anda untuk memulai.', en: 'Enter your name and access token to begin.' },
                    'full_name_label': { id: 'Nama Lengkap', en: 'Full Name' },
                    'full_name_placeholder': { id: 'Masukkan nama lengkap Anda', en: 'Enter your full name' },
                    'token_label': { id: 'Token Akses', en: 'Access Token' },
                    'token_placeholder': { id: 'Masukkan 6 digit token', en: 'Enter 6-digit token' },
                    'start_session_button': { id: 'Mulai Sesi', en: 'Start Session' },
                    'dashboard_greeting': { id: 'Halo', en: 'Hello' },
                    'dashboard_subtitle': { id: 'Temukan kekuatan Anda. Pilih tes di bawah ini untuk memulai.', en: 'Discover your strengths. Choose a test below to start.' },
                    'logout_button': { id: 'Keluar', en: 'Logout' },
                    'reco_title': { id: 'Rekomendasi Karir Terpersonalisasi', en: 'Personalized Career Recommendation' },
                    'reco_desc_unlocked': { id: 'Lihat analisis gabungan dari semua tes yang telah Anda selesaikan.', en: 'View the combined analysis from all completed tests.' },
                    'reco_desc_locked': { id: 'Selesaikan Tes IQ dan Tes Minat Bakat untuk membuka fitur ini.', en: 'Complete the IQ Test and Interest Test to unlock this feature.' },
                    'completed_status': { id: 'Selesai', en: 'Completed' },
                    'instructions_title': { id: 'Instruksi Penting', en: 'Important Instructions' },
                    'instructions_iq': { id: 'Tes ini mengukur berbagai kemampuan kognitif. Kerjakan dengan cepat dan teliti. Perhatikan setiap instruksi per bagian.', en: 'This test measures various cognitive abilities. Work quickly and accurately. Pay attention to the instructions for each section.' },
                    'instructions_riasec': { id: 'Pilih "Suka" atau "Tidak Suka" untuk setiap kegiatan. Jawablah dengan jujur sesuai minat Anda untuk mendapatkan hasil yang akurat.', en: 'Choose "Like" or "Dislike" for each activity. Answer honestly according to your interests to get accurate results.' },
                    'time_label': { id: 'Waktu Pengerjaan', en: 'Time Allotment' },
                    'minutes_label': { id: 'Menit', en: 'Minutes' },
                    'start_button': { id: 'Mulai Pengerjaan', en: 'Start Test' },
                    'back_to_dashboard_button': { id: 'Kembali ke Dashboard', en: 'Back to Dashboard' },
                    'back_button': { id: 'Kembali', en: 'Back' },
                    'prev_button': { id: 'Sebelumnya', en: 'Previous' },
                    'next_button': { id: 'Berikutnya', en: 'Next' },
                    'submit_button': { id: 'Lihat Hasil Tes', en: 'View Results' },
                    'page_progress': { id: 'Halaman {current} dari {total}', en: 'Page {current} of {total}' },
                    'question_progress': { id: 'Pertanyaan {answered} dari {total}', en: 'Question {answered} of {total}' },
                    'question_progress_simple': { id: 'Soal {current} dari {total}', en: 'Question {current} of {total}' },
                    'like_option': { id: 'Suka', en: 'Like' },
                    'dislike_option': { id: 'Tidak Suka', en: 'Dislike' },
                    'type_answer_placeholder': { id: 'Ketik jawaban Anda di sini', en: 'Type your answer here' },
                    'memorize_in_seconds': { id: 'Hafalkan informasi berikut dalam <span id="countdown" class="font-bold text-red-500">{seconds}</span> detik...', en: 'Memorize the following information in <span id="countdown" class="font-bold text-red-500">{seconds}</span> seconds...' },
                    'hafalkan_keyword': { id: 'Hafalkan:', en: 'Memorize:' },
                    'hafalkan_regex': { id: 'Hafalkan: "(.*?)"', en: 'Memorize: "(.*?)"' },
                    'hafalkan_replace_regex': { id: '.*Hafalkan: ".*?"\\s*\\.?\\s*', en: '.*Memorize: ".*?"\\s*\\.?\\s*' },
                    'download_cert_button': { id: 'Unduh Sertifikat', en: 'Download Certificate' },
                    'ok_button': { id: 'OK', en: 'OK' },

                    // Feedback messages
                    'feedback_fill_all': { id: 'Nama dan Token harus diisi.', en: 'Name and Token are required.' },
                    'feedback_token_6_digits': { id: 'Token harus terdiri dari 6 digit.', en: 'Token must be 6 digits.' },
                    'feedback_validating': { id: 'Memvalidasi akses...', en: 'Validating access...' },
                    'feedback_invalid_token': { id: 'Token yang Anda masukkan tidak valid.', en: 'The token you entered is not valid.' },
                    'feedback_timeout': { id: 'Koneksi terlalu lama. Cek internet & coba lagi.', en: 'Connection timed out. Check your internet and try again.' },
                    'feedback_time_up': { id: 'Waktu habis! Tes akan diselesaikan secara otomatis.', en: 'Time is up! The test will be submitted automatically.' },
                    'feedback_answer_first': { id: 'Silakan isi jawaban terlebih dahulu.', en: 'Please provide an answer first.' },
                    'feedback_answer_all': { id: 'Harap jawab semua pertanyaan sebelum melihat hasil.', en: 'Please answer all questions before viewing the results.' },
                    'feedback_analyzing': { id: 'Kami sedang menganalisa jawaban Anda...', en: 'We are analyzing your answers...' },
                    'feedback_analyzing_profile': { id: 'Menganalisis profil komprehensif Anda...', en: 'Analyzing your comprehensive profile...' },
                    'feedback_no_api_key': { id: 'API Key belum dimasukkan. Silakan hubungi administrator.', en: 'API Key has not been configured. Please contact the administrator.' },
                    'feedback_analysis_error': { id: 'Maaf, terjadi kesalahan saat AI menganalisis hasil.', en: 'Sorry, an error occurred while the AI was analyzing the results.' },
                    'feedback_api_connection_error': { id: 'Terjadi masalah koneksi saat menghubungi AI. Pastikan Anda terhubung ke internet dan coba lagi. Error: {error}', en: 'There was a connection issue with the AI. Please ensure you are connected to the internet and try again. Error: {error}' },
                    'feedback_cert_fail': { id: 'Gagal membuat sertifikat. Silakan coba lagi.', en: 'Failed to create certificate. Please try again.' },
                    'feedback_qr_fail': { id: 'Gagal memuat QR Code untuk sertifikat.', en: 'Failed to load QR Code for the certificate.' },
                    'feedback_memory_start': { id: 'Perhatian! Bagian tes memori akan dimulai. Anda akan diberi waktu beberapa detik untuk menghafal informasi sebelum menjawab.', en: 'Attention! The memory test section is about to begin. You will have a few seconds to memorize information before answering.' },
                    
                    // Report & Certificate
                    'report_title_for': { id: 'Laporan Psikologis untuk {name}', en: 'Psychological Report for {name}' },
                    'test_label': { id: 'Tes', en: 'Test' },
                    'completed_on_label': { id: 'Diselesaikan pada', en: 'Completed on' },
                    'date_now': { id: 'Saat ini', en: 'Just now' },
                    'report_prepared_by': { id: 'Laporan ini disusun oleh:', en: 'This report was prepared by:' },
                    'iq_cert_title': { id: 'Sertifikat Hasil Tes IQ', en: 'IQ Test Result Certificate' },
                    'participant_name': { id: 'Nama Peserta', en: 'Participant Name' },
                    'your_iq_score': { id: 'Skor IQ Anda', en: 'Your IQ Score' },
                    'category_label': { id: 'Kategori', en: 'Category' },
                    'iq_range_header': { id: 'Rentang IQ', en: 'IQ Range' },
                    'category_header': { id: 'Kategori', en: 'Category' },
                    'your_position': { id: 'Posisi Anda', en: 'Your Position' },
                    'iq_table_desc': { id: 'Tabel di atas menggambarkan klasifikasi IQ dalam populasi umum berdasarkan standar internasional.', en: 'The table above illustrates IQ classification in the general population based on international standards.' },
                    'your_score_is': { id: 'Skor IQ Anda adalah', en: 'Your IQ score is' },
                    'which_is_in_category': { id: 'yang termasuk dalam kategori', en: 'which falls into the category' },
                    'iq_disclaimer': { id: 'Nilai ini diperoleh berdasarkan performa Anda dalam mengerjakan soal visual setara standar Raven\'s APM. Tes ini mengukur kemampuan berpikir logis dan pola, bukan hasil akademis. Hasil ini hanya merupakan estimasi kognitif dan tidak dimaksudkan untuk diagnosis medis atau psikologis formal.', en: 'This score was obtained based on your performance on visual questions equivalent to the Raven\'s APM standard. This test measures logical and pattern thinking abilities, not academic results. This result is only a cognitive estimation and is not intended for formal medical or psychological diagnosis.' },
                    'your_holland_code': { id: 'Kode Holland Anda', en: 'Your Holland Code' },
                    'reco_report_title_for': { id: 'Rekomendasi Karir untuk {name}', en: 'Career Recommendation for {name}' },
                    'cert_title': { id: 'SERTIFIKAT PENYELESAIAN', en: 'CERTIFICATE OF COMPLETION' },
                    'cert_brand': { id: 'PETA POTENSI', en: 'POTENTIAL MAP' },
                    'cert_awarded_to': { id: 'Sertifikat ini diberikan kepada:', en: 'This certificate is awarded to:' },
                    'cert_completed_on': { id: 'Yang telah menyelesaikan tes pada tanggal', en: 'Who has completed the test on' },
                    'cert_summary': { id: 'Rangkuman Hasil', en: 'Result Summary' },
                    'cert_validation': { id: 'Validasi melalui QR Code', en: 'Validate via QR Code' },
                    'cert_prepared_by': { id: 'Disusun oleh,', en: 'Prepared by,' },
                    'cert_consultant': { id: 'Konsultan Psikologi', en: 'Psychological Consultant' },

                    // Prompts
                    'prompt_base': { id: 'Anda adalah seorang konsultan psikologi. Pengguna bernama {currentUser} telah menyelesaikan tes. Buat laporan psikologis yang profesional, tajam, dan bisa ditindaklanjuti dalam BAHASA INDONESIA. Gunakan format berikut untuk setiap judul bagian: [IKON:nama-ikon-fontawesome] Judul Bagian. Contoh: [IKON:fa-user-circle] Profil Umum. PENTING: Jangan gunakan karakter markdown seperti \'*\' atau \'#\'. Untuk menyorot informasi penting, apit teks dengan tag <u> dan </u>. Contoh: <u>Teks Penting</u>. Gunakan baris baru biasa untuk daftar. Di akhir laporan, tuliskan: "Laporan ini disusun oleh: Fajar, S.Psi". ', en: 'You are a psychology consultant. A user named {currentUser} has completed a test. Create a professional, sharp, and actionable psychological report in ENGLISH. Use the following format for each section title: [IKON:font-awesome-icon-name] Section Title. Example: [IKON:fa-user-circle] General Profile. IMPORTANT: Do not use markdown characters like \'*\' or \'#\'. To highlight important information, enclose the text with <u> and </u> tags. Example: <u>Important Text</u>. Use regular new lines for lists. At the end of the report, write: "This report was prepared by: Fajar, S.Psi". ' },
                    'prompt_iq': { id: 'Pengguna mendapatkan skor IQ {iqScore} (kategori: {iqCategory}). Berikan analisis singkat tentang arti skor ini dan potensi implikasinya dalam format berikut: [IKON:fa-magnifying-glass-chart] Analisis Umum, [IKON:fa-rocket] Potensi Kekuatan, [IKON:fa-compass] Area Pengembangan.', en: 'The user obtained an IQ score of {iqScore} (category: {iqCategory}). Provide a brief analysis of what this score means and its potential implications in the following format: [IKON:fa-magnifying-glass-chart] General Analysis, [IKON:fa-rocket] Potential Strengths, [IKON:fa-compass] Areas for Development.' },
                    'prompt_riasec': { id: 'Data hasil Tes Minat Bakat Holland (RIASEC) adalah Kode Holland: <u>{hollandCode}</u>. Buat bagian berikut: [IKON:fa-file-alt] Deskripsi Tipe Minat Dominan, [IKON:fa-building] Lingkungan Kerja Ideal, dan [IKON:fa-briefcase] Rekomendasi Karir Sesuai Minat.', en: 'The Holland Interest Test (RIASEC) result data is Holland Code: <u>{hollandCode}</u>. Create the following sections: [IKON:fa-file-alt] Description of Dominant Interest Types, [IKON:fa-building] Ideal Work Environment, and [IKON:fa-briefcase] Career Recommendations Based on Interests.' },
                    'prompt_reco': { id: 'Anda adalah seorang konsultan karir ahli. Berdasarkan data psikologis pengguna bernama {currentUser} ini: Skor IQ {iqScore} (Kategori: {iqCategory}) dan Kode Minat Holland {hollandCode}, berikan analisis karir yang holistik dan terperinci dalam BAHASA INDONESIA. Buat bagian-bagian berikut: [IKON:fa-user-tie] Profil Karir Anda, [IKON:fa-lightbulb] Analisis Sinergi (bagaimana IQ dan Minat saling mendukung), dan [IKON:fa-ranking-star] 5 Rekomendasi Karir Teratas (jelaskan \'Mengapa Cocok\' untuk setiap karir dengan menggabungkan kedua hasil tes). Gunakan format [IKON:nama-ikon] untuk setiap judul bagian. PENTING: Jangan gunakan karakter markdown seperti \'*\' atau \'#\'. Untuk menyorot informasi penting, apit teks dengan tag <u> dan </u>. Contoh: <u>Teks Penting</u>. Gunakan baris baru biasa untuk daftar. Di akhir laporan, tuliskan: "Laporan ini disusun oleh: Fajar, S.Psi".', en: 'You are an expert career consultant. Based on the psychological data of a user named {currentUser}: IQ Score {iqScore} (Category: {iqCategory}) and Holland Interest Code {hollandCode}, provide a holistic and detailed career analysis in ENGLISH. Create the following sections: [IKON:fa-user-tie] Your Career Profile, [IKON:fa-lightbulb] Synergy Analysis (how IQ and interests support each other), and [IKON:fa-ranking-star] Top 5 Career Recommendations (explain \'Why It Fits\' for each career by combining both test results). Use the format [IKON:icon-name] for each section title. IMPORTANT: Do not use markdown characters like \'*\' or \'#\'. To highlight important information, enclose the text with <u> and </u> tags. Example: <u>Important Text</u>. Use regular new lines for lists. At the end of the report, write: "This report was prepared by: Fajar, S.Psi".' }
                };
            }
        };


        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
