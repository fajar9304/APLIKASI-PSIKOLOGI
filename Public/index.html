<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Potensi Anda - Platform Psikotes Terintegrasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .screen { display: none; }
        .active-screen { display: block; }
        .card-hover-effect { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card-hover-effect:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .prose h3 { font-weight: 700; font-size: 1.25rem; margin-top: 1.5em; margin-bottom: 0.75em; padding-bottom: 0.25em; border-bottom: 1px solid #e5e7eb; }
        .prose ul { list-style-type: none; padding-left: 0; }
        .prose li { position: relative; padding-left: 1.75rem; margin-bottom: 0.75em; }
        .prose li::before { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: #4f46e5; position: absolute; left: 0; top: 4px; }
        #certificate-wrapper { position: absolute; left: -9999px; top: 0; width: 800px; height: 565px; }
        .riasec-label { transition: all 0.2s ease-in-out; border: 1px solid #e5e7eb; }
        input.suka-radio:checked + .riasec-label { background-image: linear-gradient(to top right, #34d399, #15803d); color: white; font-weight: 600; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border: none; }
        input.tidaksuka-radio:checked + .riasec-label { background-image: linear-gradient(to top right, #f87171, #b91c1c); color: white; font-weight: 600; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border: none; }
        .custom-alert-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .custom-alert-box { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 90%; width: 400px; transform: scale(0.95); transition: transform 0.3s ease; }
        .custom-alert-overlay.visible { opacity: 1; pointer-events: auto; }
        .custom-alert-overlay.visible .custom-alert-box { transform: scale(1); }
        .iq-table-highlight { background-color: #4338ca; color: white; font-weight: bold; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary .accordion-arrow { transform: rotate(90deg); }
        .accordion-arrow { transition: transform 0.2s ease-in-out; }
        .progress-bar-fill { transition: width 0.3s ease-in-out; }
        #next-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- Konten akan dirender oleh JavaScript -->
    </div>
    
    <!-- ===== Template Sertifikat (Hidden) ===== -->
    <div id="certificate-wrapper">
        <div id="certificate" class="bg-white p-10 flex flex-col justify-between" style="width: 800px; height: 565px; border: 10px solid #e0e7ff;">
            <div>
                <div class="flex justify-between items-start">
                    <div>
                        <h1 class="text-3xl font-bold text-indigo-800">SERTIFIKAT PENYELESAIAN</h1>
                        <p id="cert-test-name" class="text-indigo-600 text-lg">Nama Tes</p>
                    </div>
                    <div class="text-center">
                         <i class="fas fa-brain text-5xl text-indigo-500"></i>
                         <p class="font-bold text-indigo-800 mt-1">PETA POTENSI</p>
                    </div>
                </div>
                <div class="mt-8">
                    <p class="text-gray-600">Sertifikat ini diberikan kepada:</p>
                    <h2 id="cert-user-name" class="text-5xl font-bold text-gray-900 my-2">Nama Pengguna</h2>
                    <p class="text-gray-600">Yang telah menyelesaikan tes pada tanggal <span id="cert-date" class="font-semibold"></span>.</p>
                </div>
            </div>
            <div class="flex items-end justify-between">
                <div class="w-1/2 pr-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-3">Rangkuman Hasil</h3>
                    <div id="cert-scores" class="space-y-2"></div>
                </div>
                <div class="w-1/2 flex justify-between items-end">
                    <div class="text-center">
                        <img id="cert-qr-code" src="" alt="QR Code Validasi" crossorigin="anonymous" class="mx-auto">
                        <p class="text-xs text-gray-500 mt-2">Validasi melalui QR Code</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm">Disusun oleh,</p>
                        <div class="h-16"></div>
                        <p class="font-bold border-t pt-2">Fajar, S.Psi</p>
                        <p class="text-xs text-gray-500">Konsultan Psikologi</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Alert Box -->
    <div id="custom-alert" class="custom-alert-overlay">
        <div class="custom-alert-box">
            <p id="custom-alert-message" class="mb-6 text-lg"></p>
            <button id="custom-alert-close" class="bg-indigo-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-indigo-700 transition">OK</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDHmD9ePY5KMLUPYD-gLkiHsr1a1nZSAok",
            authDomain: "psikotesmandiri.firebaseapp.com",
            projectId: "psikotesmandiri",
            storageBucket: "psikotesmandiri.appspot.com",
            messagingSenderId: "460185667869",
            appId: "1:460185667869:web:ad932625381c50c17e39f4"
        };

        window.app = {
            services: {},
            state: { currentUser: null },
            async init() {
                const firebaseApp = initializeApp(firebaseConfig);
                app.services.auth = getAuth(firebaseApp);
                app.services.db = getFirestore(firebaseApp);

                try {
                    await enableIndexedDbPersistence(app.services.db);
                } catch (err) {
                    if (err.code == 'failed-precondition') {
                        console.warn("Persistence failed: Multiple tabs open");
                    } else if (err.code == 'unimplemented') {
                        console.warn("Persistence not available in this browser.");
                    }
                }

                app.auth.setupListeners();
                app.ui.renderInitialUI();
                app.ui.setupListeners();
            },
            auth: {}, 
            ui: {
                onAlertCloseCallback: null
            },
            test: {}
        };

        app.ui.renderInitialUI = () => {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div id="login-screen" class="screen">
                    <div class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
                        <div class="text-center mb-8"><i class="fas fa-brain text-5xl text-indigo-500 mb-4"></i><h1 class="text-3xl font-bold text-gray-900">Selamat Datang</h1><p class="text-gray-600 mt-2">Masukkan nama dan token akses Anda untuk memulai.</p></div>
                        <div class="space-y-4">
                            <div><label for="name-input" class="block text-sm font-medium text-gray-700">Nama Lengkap</label><input type="text" id="name-input" placeholder="Masukkan nama lengkap Anda" autocomplete="off" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label for="token-input" class="block text-sm font-medium text-gray-700">Token Akses</label><input type="tel" id="token-input" placeholder="Masukkan 6 digit token" maxlength="6" autocomplete="off" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <button id="login-btn" class="w-full flex items-center justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300">Mulai Sesi</button>
                            <p id="auth-feedback" class="text-center text-sm text-gray-600 h-4 flex items-center justify-center"></p>
                        </div>
                    </div>
                </div>
                <div id="dashboard-screen" class="screen"></div>
                <div id="start-test-screen" class="screen"></div>
                <div id="test-screen" class="screen"></div>
                <div id="results-screen" class="screen"></div>
                <div id="career-reco-screen" class="screen"></div>
            `;
        };

        app.ui.setupListeners = () => {
            const container = document.getElementById('app-container');
            container.addEventListener('click', (e) => {
                if (e.target.id === 'login-btn') app.auth.handleLogin();
                if (e.target.id === 'logout-btn') app.auth.handleLogout();
                if (e.target.id === 'start-test-button') app.test.beginActualTest();
                if (e.target.closest('#prev-btn')) app.test.prevQuestion();
                if (e.target.closest('#next-btn')) app.test.nextQuestion();
                if (e.target.closest('#submit-btn')) app.test.submitTest();
                if (e.target.closest('.back-to-dashboard')) app.ui.showScreen('dashboard-screen');
                if (e.target.closest('.confirm-analyze-btn')) app.test.confirmAndAnalyze();
                const careerCard = e.target.closest('#career-reco-card');
                if (careerCard && !careerCard.classList.contains('opacity-50')) {
                    app.test.showCareerRecommendation();
                }
            });
            
            container.addEventListener('change', (e) => {
                if (e.target.name.startsWith('q_')) { // RIASEC test answer
                    const value = e.target.value;
                    const originalIndex = e.target.dataset.originalIndex;
                    app.test.state.userAnswers[originalIndex] = value === 'suka' ? 1 : 0;
                    app.test.updateRIASECProgressBar();
                    app.test.checkRIASECPageCompletion();
                } else if (e.target.name.startsWith('question_')) { // IQ test radio answer
                    const value = e.target.value;
                    const currentQuestionIndex = app.test.state.currentQuestionIndex;
                    app.test.state.userAnswers[currentQuestionIndex] = isNaN(value) ? value : parseInt(value);
                    setTimeout(() => app.test.nextQuestion(), 300);
                }
            });

            document.getElementById('custom-alert-close').addEventListener('click', () => app.ui.hideCustomAlert());
        };

        app.ui.showScreen = (screenId) => {
            if (screenId !== 'test-screen' && app.test.state && app.test.state.testTimerInterval) {
                clearInterval(app.test.state.testTimerInterval);
                app.test.state.testTimerInterval = null;
            }
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active-screen'));
            const screenEl = document.getElementById(screenId);
            if(screenEl) screenEl.classList.add('active-screen');
        };
        
        app.ui.showCustomAlert = (message, onCloseCallback = null) => {
            document.getElementById('custom-alert-message').textContent = message;
            app.ui.onAlertCloseCallback = onCloseCallback;
            document.getElementById('custom-alert').classList.add('visible');
        };

        app.ui.hideCustomAlert = () => {
            document.getElementById('custom-alert').classList.remove('visible');
            if (typeof app.ui.onAlertCloseCallback === 'function') {
                app.ui.onAlertCloseCallback();
                app.ui.onAlertCloseCallback = null; // Reset callback after execution
            }
        };

        app.auth.setupListeners = () => {
            onAuthStateChanged(app.services.auth, (user) => {
                const sessionName = sessionStorage.getItem('userName');
                if (user && sessionName) {
                    if (!app.state.currentUser || app.state.currentUser.uid !== user.uid) {
                        app.state.currentUser = { name: sessionName, uid: user.uid };
                        app.test.init(app.state.currentUser.name);
                    }
                } else {
                    app.auth.clearSession();
                }
            });
        };
        
        app.auth.clearSession = () => {
            if (app.services.auth.currentUser) signOut(app.services.auth);
            app.state.currentUser = null;
            sessionStorage.removeItem('userName');
            app.ui.showScreen('login-screen');
        };
        
        app.auth.handleLogin = async () => {
            const name = document.getElementById('name-input').value.trim();
            const token = document.getElementById('token-input').value.trim();
            const feedbackEl = document.getElementById('auth-feedback');
            const loginBtn = document.getElementById('login-btn');

            if (!name || !token) { feedbackEl.textContent = 'Nama dan Token harus diisi.'; return; }
            if (token.length !== 6) { feedbackEl.textContent = 'Token harus terdiri dari 6 digit.'; return; }

            feedbackEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Memvalidasi akses...';
            feedbackEl.classList.remove('text-red-600');
            loginBtn.disabled = true;

            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error("Timeout")), 20000)
            );

            try {
                const loginProcess = async () => {
                    const tokenDocRef = doc(app.services.db, "accessTokens", token);
                    const tokenDocSnap = await getDoc(tokenDocRef);
                    if (!tokenDocSnap.exists()) throw new Error('Token yang Anda masukkan tidak valid.');
                    sessionStorage.setItem('userName', name);
                    await signInAnonymously(app.services.auth);
                };
                
                await Promise.race([loginProcess(), timeoutPromise]);

            } catch (error) {
                console.error("Token Login Error:", error);
                if (error.message === "Timeout") {
                    feedbackEl.textContent = "Koneksi terlalu lama. Cek internet & coba lagi.";
                } else {
                    feedbackEl.textContent = error.message;
                }
                feedbackEl.classList.add('text-red-600');
                sessionStorage.removeItem('userName');
                loginBtn.disabled = false;
            }
        };

        app.auth.handleLogout = () => signOut(app.services.auth);

        app.test.state = {
            currentUser: 'Pengguna', currentTest: null, currentQuestionIndex: 0, userAnswers: {},
            savedResults: {}, testTimerInterval: null, riasecCurrentPage: 1, riasecQuestionsPerPage: 3
        };

        app.test.data = {
            timerConfigs: { 
                'Kognitif Premium': 2700,
                'Minat Bakat Premium': 900 
            },
            allTests: {
                'IQ': { title: 'Tes IQ', icon: 'fa-lightbulb', color: 'text-purple-500', description: "Mengukur kecerdasan umum (g-factor) melalui soal visual.", premiumKey: 'Kognitif Premium' },
                'Bakat': { title: 'Tes Minat Bakat', icon: 'fa-compass', color: 'text-teal-500', description: "Menemukan tipe kepribadian dan minat karir Anda (Holland Code).", premiumKey: 'Minat Bakat Premium' }
            },
            questions: { /* Populated from defaultTestsData */ }
        };

        app.test.defaultTestsData = {
            'Kognitif Premium': {
                title: 'Tes IQ', testType: 'iq', sections: ["Penalaran Verbal", "Penalaran Numerik", "Penalaran Abstrak / Figural", "Daya Ingat / Memori", "Kecepatan dan Ketelitian"],
                questions: [
                    { id: 1, section: 0, q: 'Antonim: Kata "Optimis" berlawanan makna dengan...', answer: 'Putus asa', options: ['Percaya diri', 'Berani', 'Putus asa', 'Semangat'] },
                    { id: 2, section: 0, q: 'Analogi: Matahari : Terang = Bulan : ...', answer: 'Gelap', options: ['Gelap', 'Malam', 'Pantulan', 'Pasang'] },
                    { id: 3, section: 0, q: 'Pilih kalimat yang tidak masuk akal.', answer: 'Burung itu berenang di danau seperti lumba-lumba.', options: ['Anak itu menulis puisi dengan tangan kiri.', 'Burung itu berenang di danau seperti lumba-lumba.', 'Dia membeli es krim di musim panas.', 'Ayah membaca koran di pagi hari.'] },
                    { id: 4, section: 0, q: 'Sinonim: Kata "Cermat" bermakna sama dengan...', answer: 'Teliti', options: ['Cepat', 'Teliti', 'Ceroboh', 'Sederhana'] },
                    { id: 5, section: 0, q: 'Silogisme: Semua manusia adalah makhluk hidup. Bejo adalah manusia. Maka:', answer: 'Bejo pasti makhluk hidup.', options: ['Bejo bukan makhluk hidup.', 'Bejo mungkin makhluk hidup.', 'Bejo pasti makhluk hidup.', 'Bejo bukan manusia.'] },
                    { id: 6, section: 0, passage: "Pohon mangga di halaman rumah nenek sangat rimbun. Buahnya manis dan besar-besar. Setiap musim panen, nenek selalu membagikan mangga kepada tetangga dan cucu-cucunya yang datang berkunjung.", q: 'Apa yang dilakukan nenek saat musim panen tiba?', answer: 'Membagikan buah mangga kepada orang lain.', options: ['Menjual semua mangganya di pasar.', 'Membagikan buah mangga kepada orang lain.', 'Membiarkan buahnya jatuh begitu saja.', 'Menebang pohon mangga tersebut.'] },
                    { id: 7, section: 0, passageId: 6, q: 'Mengapa pohon mangga itu disukai banyak orang?', answer: 'Karena buahnya memiliki rasa yang enak.', options: ['Karena pohonnya sangat tinggi.', 'Karena daunnya sangat rimbun.', 'Karena buahnya memiliki rasa yang enak.', 'Karena terletak di halaman rumah nenek.'] },
                    { id: 8, section: 0, passage: "Revolusi industri mengubah cara manusia memproduksi barang. Sebelum adanya mesin uap, sebagian besar pekerjaan dilakukan dengan tangan. Setelah penemuan tersebut, pabrik-pabrik besar mulai bermunculan dan produksi massal menjadi mungkin.", q: 'Apa dampak utama dari penemuan mesin uap?', answer: 'Pekerjaan dapat dilakukan lebih cepat dan dalam skala besar.', options: ['Manusia menjadi lebih malas.', 'Pekerjaan dapat dilakukan lebih cepat dan dalam skala besar.', 'Jumlah pengrajin tangan meningkat pesat.', 'Barang-barang menjadi lebih langka.'] },
                    { id: 9, section: 0, passageId: 8, q: 'Bagaimana kondisi produksi sebelum revolusi industri?', answer: 'Bergantung pada tenaga manual atau tangan.', options: ['Sangat modern dan efisien.', 'Bergantung pada tenaga manual atau tangan.', 'Sudah menggunakan mesin otomatis.', 'Tidak ada kegiatan produksi sama sekali.'] },
                    { id: 10, section: 0, passage: "Kucing adalah hewan karnivora yang aktif di malam hari (nokturnal). Mereka biasanya menghabiskan waktu siang hari untuk tidur dan menyimpan energi. Di malam hari, insting berburu mereka menjadi lebih tajam.", q: 'Kapan waktu kucing paling aktif?', answer: 'Malam', options: ['Siang', 'Sore', 'Malam', 'Pagi'] },
                    { id: 11, section: 0, passageId: 10, q: 'Mengapa kucing tidur di siang hari?', answer: 'Untuk menyimpan energi untuk beraktivitas di malam hari.', options: ['Karena mereka merasa bosan.', 'Untuk menyimpan energi untuk beraktivitas di malam hari.', 'Karena cuaca siang hari terlalu panas.', 'Karena mereka tidak suka cahaya matahari.'] },
                    { id: 12, section: 0, passageId: 10, q: 'Apa jenis makanan utama kucing berdasarkan teks?', answer: 'Daging', options: ['Tumbuhan', 'Biji-bijian', 'Daging', 'Segala jenis makanan'] },
                    { id: 13, section: 1, q: 'Deret Angka: 2, 4, 8, 16, ...', answer: '32', options: ['20', '24', '32', '36'] },
                    { id: 14, section: 1, q: '4x – 7 = 13, maka x = ?', answer: '5', options: ['5', '4', '3', '2'] },
                    { id: 15, section: 1, q: 'Jika 3 * 2 = 12 dan 4 * 5 = 40, maka 6 * 2 = ? (Logika: a * b = (a*b) * 2)', answer: '24', options: ['12', '24', '18', '36'] },
                    { id: 16, section: 1, q: 'Jika 3 apel seharga Rp9.000, berapa harga 5 apel?', answer: 'Rp15.000', options: ['Rp13.500', 'Rp15.000', 'Rp12.000', 'Rp10.000'] },
                    { id: 17, section: 1, q: '3/4 + 2/5 = ?', answer: '1 3/20', options: ['1 3/4', '1 1/2', '1 3/20', '1 2/5'] },
                    { id: 18, section: 1, q: 'Deret Angka: 81, 27, 9, 3, ...', answer: '1', options: ['1', '0', '1/3', '-3'] },
                    { id: 19, section: 1, q: 'Budi punya 4 kantong, masing-masing berisi 6 kelereng. Jika ia memberikan 8 kelereng kepada temannya, berapa sisa kelerengnya?', answer: '16', options: ['24', '32', '16', '14'] },
                    { id: 20, section: 1, q: 'Sebuah kereta berangkat pukul 07:45 dan tiba pukul 11:15. Berapa lama perjalanan kereta tersebut?', answer: '3 jam 30 menit', options: ['3 jam 15 menit', '3 jam 30 menit', '4 jam', '2 jam 45 menit'] },
                    { id: 21, section: 1, q: 'Dalam sebuah kelas, perbandingan jumlah siswa laki-laki dan perempuan adalah 3:5. Jika jumlah siswa perempuan adalah 25 orang, berapa jumlah siswa laki-laki?', answer: '15', options: ['10', '15', '20', '30'] },
                    { id: 22, section: 1, q: 'Ani membeli buku seharga Rp25.000 dan mendapat diskon 20%. Berapa uang yang harus Ani bayarkan?', answer: 'Rp20.000', options: ['Rp5.000', 'Rp15.000', 'Rp20.000', 'Rp22.500'] },
                    { id: 23, section: 1, q: 'Sebuah mobil menempuh jarak 120 km dengan 10 liter bensin. Jika mobil tersebut akan menempuh jarak 180 km, berapa liter bensin yang dibutuhkan?', answer: '15 liter', options: ['12 liter', '15 liter', '18 liter', '20 liter'] },
                    { id: 24, section: 1, q: 'Ayah berusia 3 kali usia anaknya. Jika jumlah usia mereka sekarang adalah 48 tahun, berapa usia sang anak?', answer: '12 tahun', options: ['10 tahun', '12 tahun', '14 tahun', '16 tahun'] },
                    { id: 25, section: 2, isVisual: true, q: 'Melengkapi Pola: [Persegi, Lingkaran, Segitiga, Persegi, Lingkaran, ...]', answer: 'Segitiga', options: ['Persegi', 'Lingkaran', 'Segitiga'] },
                    { id: 26, section: 2, isVisual: true, q: 'Gambar Berbeda: Dari kelima jam di bawah, manakah yang menunjukkan waktu berbeda?', answer: 'C', options: ['A', 'B', 'C', 'D', 'E'] },
                    { id: 27, section: 2, isVisual: true, q: 'Rotasi Bentuk: Panah menunjuk ke atas. Mana rotasi 90 derajat searah jarum jam?', answer: 'Panah ke kanan', options: ['Panah ke kanan atas', 'Panah ke kanan', 'Panah ke bawah'] },
                    { id: 28, section: 2, isVisual: true, q: 'Analogi Visual: Lingkaran utuh menjadi setengah lingkaran. Bagaimana Persegi utuh akan berubah?', answer: 'Setengah persegi/persegi panjang', options: ['Dua persegi', 'Setengah persegi/persegi panjang', 'Segitiga'] },
                    { 
                        id: 29, section: 2, isVisual: true, 
                        q: 'Simetri: Pilih gambar kanan yang simetris dengan gambar kiri.', 
                        answer: 'B', 
                        visualQuestion: `<div class="flex justify-center items-center my-4 p-4 bg-gray-100 rounded-lg"><svg width="100" height="100" viewBox="0 0 100 100"><path d="M50 5 C 5 20, 5 80, 50 95" stroke="black" fill="#facc15" stroke-width="2"/></svg></div>`,
                        options: [
                            { value: 'A', visual: `<svg width="100" height="100" viewBox="0 0 100 100"><path d="M50 5 C 5 20, 5 80, 50 95" stroke="black" fill="#facc15" stroke-width="2" transform="rotate(90 50 50)"/></svg>` },
                            { value: 'B', visual: `<svg width="100" height="100" viewBox="0 0 100 100"><path d="M50 5 C 95 20, 95 80, 50 95" stroke="black" fill="#facc15" stroke-width="2"/></svg>` },
                            { value: 'C', visual: `<svg width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" stroke="black" fill="#facc15" stroke-width="2"/></svg>` }
                        ]
                    },
                    { 
                        id: 30, section: 2, isVisual: true, 
                        q: 'Matriks Progresif: Isi kotak kosong pada matriks 3x3.', 
                        answer: 'C',
                        visualQuestion: `<div class="flex justify-center items-center my-4 p-4 bg-gray-100 rounded-lg"><svg width="180" height="180" viewBox="0 0 180 180" style="border: 1px solid #ccc;"><g stroke="black" stroke-width="2" fill="none"><circle cx="30" cy="30" r="20"/><circle cx="90" cy="30" r="20"/><line x1="90" y1="10" x2="90" y2="50"/><circle cx="150" cy="30" r="20"/><line x1="150" y1="10" x2="150" y2="50"/><line x1="130" y1="30" x2="170" y2="30"/><rect x="10" y="70" width="40" height="40"/><rect x="70" y="70" width="40" height="40"/><line x1="90" y1="70" x2="90" y2="110"/><rect x="130" y="70" width="40" height="40"/><line x1="150" y1="70" x2="150" y2="110"/><line x1="130" y1="90" x2="170" y2="90"/><polygon points="30,160 10,120 50,120"/><polygon points="90,160 70,120 110,120"/><line x1="90" y1="120" x2="90" y2="160"/><text x="145" y="145" font-size="40" fill="#9ca3af">?</text></g></svg></div>`,
                        options: [
                            { value: 'A', visual: `<svg width="60" height="60" viewBox="0 0 60 60"><polygon points="30,50 10,10 50,10" stroke="black" fill="none" stroke-width="2"/></svg>` },
                            { value: 'B', visual: `<svg width="60" height="60" viewBox="0 0 60 60"><polygon points="30,50 10,10 50,10" stroke="black" fill="none" stroke-width="2"/><line x1="30" y1="10" x2="30" y2="50"/></svg>` },
                            { value: 'C', visual: `<svg width="60" height="60" viewBox="0 0 60 60"><polygon points="30,50 10,10 50,10" stroke="black" fill="none" stroke-width="2"/><line x1="30" y1="10" x2="30" y2="50"/><line x1="10" y1="30" x2="50" y2="30"/></svg>` }
                        ]
                    },
                    { id: 31, section: 2, isVisual: true, q: 'Pemisahan Ruang: Sebuah kotak dibagi menjadi beberapa bagian oleh garis-garis. Hitung jumlah total area.', answer: '6', options: ['4', '5', '6', '7'] },
                    { 
                        id: 32, section: 2, isVisual: true, 
                        q: 'Pola Lipatan Kertas: Kertas dilipat lalu dilubangi. Pilih kondisi kertas setelah dibuka.', 
                        answer: 'B',
                        visualQuestion: `<div class="flex justify-center items-center my-4 p-4 bg-gray-100 rounded-lg space-x-4 text-gray-500"><svg width="50" height="50"><rect x="0" y="0" width="50" height="50" fill="white" stroke="black"/></svg><span>→</span><svg width="25" height="50"><rect x="0" y="0" width="25" height="50" fill="white" stroke="black"/><path d="M 25 0 L 25 50" stroke-dasharray="2 2" stroke="gray"/></svg><span>→</span><svg width="25" height="25"><rect x="0" y="0" width="25" height="25" fill="white" stroke="black"/><circle cx="5" cy="5" r="3" fill="black"/><path d="M 25 0 L 25 25" stroke-dasharray="2 2" stroke="gray"/><path d="M 0 25 L 25 25" stroke-dasharray="2 2" stroke="gray"/></svg></div>`,
                        options: [
                            { value: 'A', visual: `<svg width="60" height="60" viewBox="0 0 60 60"><rect x="5" y="5" width="50" height="50" fill="white" stroke="black"/><circle cx="30" cy="30" r="3" fill="black"/></svg>` },
                            { value: 'B', visual: `<svg width="60" height="60" viewBox="0 0 60 60"><rect x="5" y="5" width="50" height="50" fill="white" stroke="black"/><circle cx="15" cy="15" r="3" fill="black"/><circle cx="45" cy="15" r="3" fill="black"/><circle cx="15" cy="45" r="3" fill="black"/><circle cx="45" cy="45" r="3" fill="black"/></svg>` },
                            { value: 'C', visual: `<svg width="60" height="60" viewBox="0 0 60 60"><rect x="5" y="5" width="50" height="50" fill="white" stroke="black"/><circle cx="15" cy="30" r="3" fill="black"/><circle cx="45" cy="30" r="3" fill="black"/></svg>` }
                        ]
                    },
                    { 
                        id: 33, section: 2, isVisual: true, 
                        q: 'Hubungan Spasial: Tiga objek ditumpuk seperti pada gambar. Mana yang paling bawah?', 
                        answer: 'Kubus',
                        visualQuestion: `<div class="flex justify-center items-center my-4 p-4 bg-gray-100 rounded-lg"><svg width="100" height="120" viewBox="0 0 100 120"><g fill-opacity="0.8"><polygon points="50,0 20,30 80,30" style="fill:#ef4444;"/><circle cx="50" cy="55" r="25" style="fill:#3b82f6;"/><path d="M10 80 L40 70 L90 90 L60 100 Z" style="fill:#22c55e;"/><path d="M10 80 L10 110 L60 100 L60 70 Z" style="fill:#16a34a;"/><path d="M40 70 L40 100 L60 100 L60 70 Z" style="fill:#15803d;"/></g></svg></div>`,
                        options: ['Bola', 'Piramida', 'Kubus']
                    },
                    { id: 34, section: 2, isVisual: true, q: 'Identifikasi Pola Tersembunyi: Temukan bentuk bintang pada gambar kompleks.', answer: 'Ada', options: ['Ada', 'Tidak Ada'] },
                    { 
                        id: 35, section: 2, isVisual: true, 
                        q: 'Analogi Visual: Perhatikan hubungan antara gambar A dan B. Terapkan pola yang sama untuk gambar C.', 
                        answer: 'B',
                        visualQuestion: `<div class="flex justify-center items-center my-4 p-4 bg-gray-100 rounded-lg space-x-4 text-xl"><div class="text-center"><p>A</p><svg width="50" height="50"><circle cx="25" cy="25" r="15" stroke="black" fill="none" stroke-width="2"/></svg></div><span>:</span><div class="text-center"><p>B</p><svg width="50" height="50"><circle cx="25" cy="25" r="15" stroke="black" fill="none" stroke-width="2"/><line x1="25" y1="10" x2="25" y2="40" stroke="black" stroke-width="2"/></svg></div><span class="ml-8">::</span><div class="text-center"><p>C</p><svg width="50" height="50"><rect x="10" y="10" width="30" height="30" stroke="black" fill="none" stroke-width="2"/></svg></div><span>:</span><span class="font-bold text-gray-500">?</span></div>`,
                        options: [
                            { value: 'A', visual: `<svg width="60" height="60" viewBox="0 0 60 60"><rect x="15" y="15" width="30" height="30" stroke="black" fill="none" stroke-width="2"/></svg>` },
                            { value: 'B', visual: `<svg width="60" height="60" viewBox="0 0 60 60"><rect x="15" y="15" width="30" height="30" stroke="black" fill="none" stroke-width="2"/><line x1="30" y1="15" x2="30" y2="45" stroke="black" stroke-width="2"/></svg>` },
                            { value: 'C', visual: `<svg width="60" height="60" viewBox="0 0 60 60"><rect x="15" y="15" width="30" height="30" stroke="black" fill="none" stroke-width="2"/><line x1="15" y1="15" x2="45" y2="45" stroke="black" stroke-width="2"/></svg>` }
                        ]
                    },
                    { id: 36, section: 2, isVisual: true, q: 'Gambar Berbeda (Detail): Lima wajah tersenyum, satu memiliki alis berbeda. Temukan yang berbeda.', answer: 'Wajah D', options: ['Wajah A', 'Wajah B', 'Wajah C', 'Wajah D'] },
                    { id: 37, section: 3, q: 'Urutan Angka Terbalik: Hafalkan: "7, 3, 9, 2, 4". Tuliskan kembali dalam urutan terbalik.', answer: '4, 2, 9, 3, 7' },
                    { id: 38, section: 3, q: 'Cerita Singkat 1: Hafalkan: "Pada hari Minggu pagi, Pak Budi pergi memancing di sungai. Ia berhasil mendapatkan tiga ikan besar." Pertanyaan: Kapan Pak Budi pergi memancing?', answer: 'Minggu pagi' },
                    { id: 39, section: 3, q: 'Huruf Acak: Hafalkan: "H M R U A". Temukan kata bermakna dari huruf-huruf tersebut.', answer: 'RUMAH' },
                    { id: 40, section: 3, q: 'Cerita Singkat 2: Hafalkan: "Sinta pergi ke pasar membeli apel, jeruk, dan mangga. Ia naik sepeda dan membawa keranjang berwarna merah." Pertanyaan: Apa warna keranjang yang dibawa Sinta?', answer: 'Merah' },
                    { id: 41, section: 3, q: 'Urutan Warna: Hafalkan: "Merah - Biru - Kuning - Hijau". Manakah urutan yang benar?', answer: 'Merah - Biru - Kuning - Hijau', options: ['Merah - Kuning - Biru - Hijau', 'Merah - Biru - Kuning - Hijau', 'Biru - Merah - Hijau - Kuning'] },
                    { id: 42, section: 3, q: 'Pasangan Simbol-Angka: Hafalkan: "A1 = 3, B2 = 5, C3 = 7". Berapakah nilai untuk D4 jika polanya berlanjut?', answer: '9' },
                    { id: 43, section: 3, q: 'Mengingat Benda: Hafalkan: "Buku, Pensil, Gelas". Sebutkan salah satu benda yang ditampilkan.', answer: ['Buku', 'Pensil', 'Gelas'] },
                    { id: 44, section: 3, q: 'Cerita Singkat 3: Hafalkan: "Dina adalah seorang dokter hewan. Kemarin ia merawat seekor anjing pudel yang kakinya terluka." Pertanyaan: Apa profesi Dina?', answer: 'Dokter hewan' },
                    { id: 45, section: 3, q: 'Urutan Kata: Hafalkan: "Rumah - Jalan - Kota - Negara". Tuliskan kembali urutannya.', answer: 'Rumah - Jalan - Kota - Negara' },
                    { id: 46, section: 3, q: 'Pasangan Logika: Hafalkan: "Kucing = Meong dan Anjing = Gukguk". Maka Sapi = ?', answer: 'Moo' },
                    { id: 47, section: 3, q: 'Mengingat Alamat: Hafalkan: "Toko Buku ABC terletak di Jalan Merpati No. 25." Pertanyaan: Di jalan apa toko buku itu berada?', answer: 'Jalan Merpati' },
                    { id: 48, section: 3, q: 'Simbol dan Arah: Hafalkan: "↑ ↓ → ←". Tuliskan kembali urutan simbol tersebut.', answer: '↑ ↓ → ←' },
                    { id: 49, section: 4, q: 'Pilih Angka Berbeda: 38261, 38261, 38261, 38216', answer: '38216', options: ['38261', '38261', '38261', '38216'] },
                    { id: 50, section: 4, q: 'Pilih Huruf Berbeda: A B C D E F G H J K L M', answer: 'I tidak ada', options: ['H', 'J', 'K', 'I tidak ada'] },
                    { id: 51, section: 4, q: 'Hitung Cepat: (28 + 17) – (12 + 9) = ?', answer: '24', options: ['22', '24', '26', '28'] },
                    { id: 52, section: 4, q: 'Cocokkan Simbol: Perhatikan barisan ini: ⚫🔺🔺⚫⚫. Berapa jumlah simbol 🔺?', answer: '2', options: ['1', '2', '3'] },
                    { id: 53, section: 4, q: 'Temukan Pasangan Sama: Mana pasangan yang identik?', answer: 'MN890 - MN890', options: ['KL567 - KL576', 'MN890 - MN890', 'PQ123 - Pq123'] },
                    { id: 54, section: 4, q: 'Hitung Huruf \'a\': "Kemarin Ayah saya membeli alpukat di pasar."', answer: '7', options: ['6', '7', '8'] },
                    { id: 55, section: 4, q: 'Perbandingan Cepat: Mana yang lebih besar, 5/8 atau 4/7?', answer: '5/8', options: ['5/8', '4/7', 'Sama besar'] },
                    { id: 56, section: 4, q: 'Pilih Pasangan Tidak Berurutan:', answer: '2468', options: ['1234', '5678', '9876', '2468'] },
                    { id: 57, section: 4, q: 'Mencocokkan Kombinasi: Jika A=1, B=2, C=3, mana kombinasi yang benar?', answer: 'C3', options: ['A2', 'B3', 'C3'] },
                    { id: 58, section: 4, q: 'Temukan Simbol yang Hilang: ⚫🔺◼️...⚫🔺◼️', answer: '◻️', options: ['⚫', '🔺', '◼️', '◻️'] },
                    { id: 59, section: 4, q: 'Hitung Cepat: 15 x 4 ÷ 2 = ?', answer: '30', options: ['30', '45', '60'] },
                    { id: 60, section: 4, q: 'Identifikasi Kesalahan: "Burung bisa terbang karna memiliki sayap." Di mana letak kesalahannya?', answer: 'karna', options: ['Burung', 'terbang', 'karna', 'sayap'] },
                ]
            },
            'Minat Bakat Premium': {
                title: 'Tes Minat Bakat Holland Code (RIASEC)',
                testType: 'riasec',
                questions: [
                    { text: "Memperbaiki peralatan elektronik atau mekanik.", type: 'R' }, { text: "Bekerja di luar ruangan (outdoor).", type: 'R' }, { text: "Menggunakan perkakas atau mesin.", type: 'R' }, { text: "Mengemudikan truk atau traktor.", type: 'R' }, { text: "Membangun sesuatu dengan kayu.", type: 'R' }, { text: "Bekerja dengan tangan (misal: merakit).", type: 'R' }, { text: "Mengikuti kursus pertukangan atau otomotif.", type: 'R' }, { text: "Berolahraga atau aktivitas fisik.", type: 'R' }, { text: "Bekerja di bidang konstruksi.", type: 'R' }, { text: "Memelihara taman atau kebun.", type: 'R' },
                    { text: "Melakukan penelitian ilmiah.", type: 'I' }, { text: "Memecahkan soal matematika atau logika.", type: 'I' }, { text: "Membaca buku atau artikel ilmiah.", type: 'I' }, { text: "Bekerja di laboratorium.", type: 'I' }, { text: "Menganalisis data atau statistik.", type: 'I' }, { text: "Mempelajari cara kerja alam semesta.", type: 'I' }, { text: "Menulis artikel tentang penemuan baru.", type: 'I' }, { text: "Menggunakan mikroskop atau teleskop.", type: 'I' }, { text: "Mengembangkan sebuah teori.", type: 'I' }, { text: "Melakukan eksperimen.", type: 'I' },
                    { text: "Melukis, menggambar, atau memahat.", type: 'A' }, { text: "Bermain alat musik.", type: 'A' }, { text: "Menulis cerita, puisi, atau naskah drama.", type: 'A' }, { text: "Menjadi aktor atau aktris dalam sebuah pertunjukan.", type: 'A' }, { text: "Mendesain pakaian atau interior.", type: 'A' }, { text: "Mengambil foto artistik.", type: 'A' }, { text: "Menyanyi solo atau dalam paduan suara.", type: 'A' }, { text: "Menghadiri konser, teater, atau pameran seni.", type: 'A' }, { text: "Menciptakan tarian atau koreografi.", type: 'A' }, { text: "Membuat sketsa ide-ide kreatif.", type: 'A' },
                    { text: "Mengajar atau melatih orang lain.", type: 'S' }, { text: "Membantu orang lain memecahkan masalah pribadi mereka.", type: 'S' }, { text: "Bekerja sebagai sukarelawan.", type: 'S' }, { text: "Merawat orang sakit atau anak-anak.", type: 'S' }, { text: "Menjadi penasihat atau konselor.", type: 'S' }, { text: "Bekerja dalam tim untuk tujuan sosial.", type: 'S' }, { text: "Mendengarkan cerita dan masalah teman.", type: 'S' }, { text: "Mengorganisir acara komunitas.", type: 'S' }, { text: "Menjadi seorang terapis.", type: 'S' }, { text: "Menjelaskan sesuatu kepada orang lain.", type: 'S' },
                    { text: "Memimpin sebuah tim atau proyek.", type: 'E' }, { text: "Meyakinkan atau memengaruhi orang lain.", type: 'E' }, { text: "Menjual sebuah produk atau ide.", type: 'E' }, { text: "Memberikan pidato di depan umum.", type: 'E' }, { text: "Memulai bisnis sendiri.", type: 'E' }, { text: "Mengatur dan mengelola sebuah acara besar.", type: 'E' }, { text: "Bernegosiasi untuk mendapatkan kesepakatan.", type: 'E' }, { text: "Menjadi manajer atau eksekutif.", type: 'E' }, { text: "Mencari peluang untuk mendapatkan keuntungan.", type: 'E' }, { text: "Memotivasi orang lain untuk mencapai tujuan.", type: 'E' },
                    { text: "Mengelola anggaran atau catatan keuangan.", type: 'C' }, { text: "Bekerja dengan angka dan data.", type: 'C' }, { text: "Membuat jadwal atau rencana yang terperinci.", type: 'C' }, { text: "Mengorganisir file dan dokumen.", type: 'C' }, { text: "Mengikuti prosedur dan aturan yang jelas.", type: 'C' }, { text: "Memeriksa dokumen untuk mencari kesalahan (proofreading).", type: 'C' }, { text: "Bekerja di kantor.", type: 'C' }, { text: "Menggunakan spreadsheet atau database.", type: 'C' }, { text: "Menyusun laporan berdasarkan data.", type: 'C' }, { text: "Memastikan semua detail sudah benar dan akurat.", type: 'C' }
                ]
            }
        };

        app.test.init = (userName) => {
            app.test.state.currentUser = userName;
            app.test.loadAppData();
            app.test.updateDashboard();
            app.ui.showScreen('dashboard-screen');
        };

        app.test.updateDashboard = () => {
            const dashboardScreen = document.getElementById('dashboard-screen');
            let cardsHTML = '';
            for (const testKey in app.test.data.allTests) {
                const testInfo = app.test.data.allTests[testKey];
                const isCompleted = app.test.state.savedResults[testInfo.premiumKey];
                const completedClass = isCompleted ? 'bg-green-50 border-green-600' : 'bg-white';
                const statusHTML = isCompleted ? `<span class="bg-violet-200 text-violet-800 text-xs font-bold px-2.5 py-0.5 rounded-full"><i class="fas fa-star mr-1"></i>Selesai</span>` : '';
                
                cardsHTML += `
                    <div data-testid="${testInfo.premiumKey}" class="test-card ${completedClass} p-6 rounded-xl shadow-md card-hover-effect cursor-pointer">
                        <div class="flex justify-between items-start">
                            <i class="fas ${testInfo.icon} text-3xl ${testInfo.color} mb-3"></i>
                            ${statusHTML}
                        </div>
                        <h3 class="font-bold text-lg">${testInfo.title}</h3>
                        <p class="text-sm text-gray-500">${testInfo.description}</p>
                    </div>
                `;
            }
            
            const requiredKeys = Object.values(app.test.data.allTests).map(test => test.premiumKey);
            const allTestsDone = requiredKeys.every(key => app.test.state.savedResults[key]);
            const recoCardState = allTestsDone ? 'cursor-pointer' : 'opacity-50 cursor-not-allowed';
            const recoCardDesc = allTestsDone ? 'Lihat analisis gabungan dari semua tes yang telah Anda selesaikan.' : 'Selesaikan Tes IQ dan Tes Minat Bakat untuk membuka fitur ini.';

            const careerRecoCard = `
                <div id="career-reco-card" class="bg-indigo-600 text-white p-6 rounded-xl shadow-lg card-hover-effect ${recoCardState} md:col-span-2">
                     <div class="flex items-center">
                        <i class="fas fa-briefcase text-3xl mr-4"></i>
                        <div>
                            <h3 class="font-bold text-lg">Rekomendasi Karir Terpersonalisasi</h3>
                            <p class="text-sm text-indigo-200">${recoCardDesc}</p>
                        </div>
                    </div>
                </div>
            `;

            dashboardScreen.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8 flex flex-col sm:flex-row justify-between items-center text-center sm:text-left">
                    <div class="flex items-center mb-4 sm:mb-0">
                        <i class="fas fa-brain text-4xl text-indigo-500 mr-5"></i>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900 mb-1">Halo, <span id="user-name-display">${app.test.state.currentUser}</span>!</h1>
                            <p class="text-gray-600">Temukan kekuatan Anda. Pilih tes di bawah ini untuk memulai.</p>
                        </div>
                    </div>
                    <button id="logout-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition text-sm w-full sm:w-auto">
                        <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                    </button>
                </div>
                <div id="test-dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${cardsHTML}
                    ${careerRecoCard}
                </div>
            `;
            
            dashboardScreen.querySelector('#test-dashboard-grid').addEventListener('click', (e) => {
                const card = e.target.closest('.test-card');
                if (card) {
                    const testId = card.dataset.testid;
                    if (app.test.state.savedResults[testId]) {
                        app.test.viewResult(testId);
                    } else {
                        app.test.startTest(testId);
                    }
                }
            });
        };
        
        app.test.startTest = (testKey) => {
            app.test.state.currentTestKey = testKey;
            app.test.state.currentTest = { name: testKey, ...app.test.data.questions[testKey] };
            app.test.state.userAnswers = {};
            app.test.state.currentQuestionIndex = 0;
            app.test.state.riasecCurrentPage = 1;

            const timeInSeconds = app.test.data.timerConfigs[testKey];
            let instructions = '';
            if (testKey === 'Kognitif Premium') {
                instructions = 'Tes ini mengukur berbagai kemampuan kognitif. Kerjakan dengan cepat dan teliti. Perhatikan setiap instruksi per bagian.';
            } else if (testKey === 'Minat Bakat Premium') {
                instructions = 'Pilih "Suka" atau "Tidak Suka" untuk setiap kegiatan. Jawablah dengan jujur sesuai minat Anda untuk mendapatkan hasil yang akurat.';
            }
            
            const startScreen = document.getElementById('start-test-screen');
            startScreen.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">${app.test.state.currentTest.title}</h2>
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 mb-6 rounded-r-lg text-left"><p class="font-bold mb-2">Instruksi Penting:</p><p>${instructions}</p></div>
                    <div class="flex justify-center items-center text-lg text-gray-700 mb-8"><i class="far fa-clock mr-3 text-2xl"></i><div><p>Waktu Pengerjaan:</p><p class="font-bold text-2xl text-indigo-600">${timeInSeconds / 60} Menit</p></div></div>
                    <button id="start-test-button" class="w-full max-w-sm mx-auto bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-300">Mulai Pengerjaan</button>
                    <button class="back-to-dashboard w-full mt-3 text-sm text-gray-500 hover:underline">Kembali ke Dashboard</button>
                </div>`;
            app.ui.showScreen('start-test-screen');
        };

        app.test.beginActualTest = () => {
            let timeLeft = app.test.data.timerConfigs[app.test.state.currentTestKey];
            const testScreen = document.getElementById('test-screen');
            testScreen.innerHTML = `
                <div class="bg-white p-4 rounded-xl shadow-md mb-6 flex justify-between items-center sticky top-4 z-10">
                    <button class="back-to-dashboard text-indigo-600 hover:text-indigo-800 text-sm"><i class="fas fa-arrow-left mr-2"></i>Kembali</button>
                    <div class="font-bold text-xl text-red-600 bg-red-100 px-4 py-2 rounded-full"><i class="far fa-clock mr-2"></i><span id="time-remaining">${app.test.formatTime(timeLeft)}</span></div>
                </div>
                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                    <h2 id="test-title" class="text-2xl font-bold mb-2 text-center"></h2>
                    <p id="test-section-title" class="text-center text-gray-500 mb-6"></p>
                    <div id="progress-bar-container" class="mb-6"></div>
                    <div id="question-container"></div>
                    <div id="navigation-container" class="flex justify-between items-center mt-8">
                        <button id="prev-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-full hover:bg-gray-300 transition duration-300">Sebelumnya</button>
                        <div id="progress-text" class="text-sm text-gray-500"></div>
                        <button id="next-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-700 transition duration-300">Berikutnya</button>
                        <button id="submit-btn" class="hidden w-full bg-green-600 text-white font-bold py-3 px-4 rounded-full hover:bg-green-700 transition duration-300 transform hover:scale-105">Lihat Hasil Tes</button>
                    </div>
                </div>`;
            
            app.ui.showScreen('test-screen');
            const timerEl = document.getElementById('time-remaining');
            
            app.test.state.testTimerInterval = setInterval(() => {
                timeLeft--;
                if(timerEl) timerEl.textContent = app.test.formatTime(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(app.test.state.testTimerInterval);
                    app.test.state.testTimerInterval = null;
                    app.test.autoSubmitTest();
                }
            }, 1000);

            if (app.test.state.currentTest.testType === 'riasec') {
                app.test.state.currentTest.questions = [...app.test.state.currentTest.questions]
                    .map((q, i) => ({...q, originalIndex: i}))
                    .sort(() => Math.random() - 0.5);
                app.test.renderRIASECPage();
            } else {
                app.test.renderQuestion();
            }
        };

        app.test.autoSubmitTest = () => {
            app.ui.showCustomAlert("Waktu habis! Tes akan diselesaikan secara otomatis.");
            app.test.confirmAndAnalyze();
        };
        
        app.test.formatTime = (seconds) => {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        };

        app.test.renderQuestion = () => {
            const { currentTest, currentQuestionIndex, userAnswers } = app.test.state;
            
            document.getElementById('test-title').textContent = currentTest.title;
            const questionData = currentTest.questions[currentQuestionIndex];
            const container = document.getElementById('question-container');
            
            let sectionTitle = '';
            if (currentTest.sections) {
                sectionTitle = currentTest.sections[questionData.section];
                document.getElementById('test-section-title').textContent = sectionTitle;
            }
            
            const startMemoryCountdown = () => {
                const stimulusMatch = questionData.q.match(/Hafalkan: "(.*?)"/);
                const stimulus = stimulusMatch ? stimulusMatch[1] : '';
                const taskText = questionData.q.replace(/.*Hafalkan: ".*?"\s*\.?\s*/, '').trim();

                let questionHTML = `
                    <div id="memory-stimulus" class="text-center p-4">
                        <p class="text-gray-600 mb-2">Hafalkan informasi berikut dalam <span id="countdown" class="font-bold text-red-500">7</span> detik...</p>
                        <div class="text-xl font-semibold text-indigo-700 p-4 bg-indigo-50 rounded-lg">${stimulus}</div>
                    </div>
                    <div id="memory-task" class="hidden">
                        <p class="text-lg mb-4 text-center">${taskText}</p>
                    </div>`;
                
                let optionsHTML = '<div id="options-container-wrapper" class="hidden flex flex-col items-center space-y-3 w-full max-w-md">';
                
                if (questionData.options) {
                    let options = [...questionData.options];
                    options.sort(() => Math.random() - 0.5);

                    options.forEach((option, index) => {
                        const optionValue = option.value !== undefined ? option.value : option;
                        const optionId = `q${currentQuestionIndex}_option${index}`;
                        const isChecked = userAnswers[currentQuestionIndex] !== undefined && String(userAnswers[currentQuestionIndex]) == String(optionValue);
                        optionsHTML += `
                            <div class="w-full">
                                <input type="radio" id="${optionId}" name="question_${currentQuestionIndex}" value="${optionValue}" class="hidden peer" ${isChecked ? 'checked' : ''}>
                                <label for="${optionId}" class="block w-full text-center p-3 border border-gray-300 rounded-lg cursor-pointer peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 hover:bg-indigo-50">${option.text || option}</label>
                            </div>`;
                    });
                } else {
                    optionsHTML += `<input type="text" id="text-input-${currentQuestionIndex}" class="block w-full text-center p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Ketik jawaban Anda di sini" value="${userAnswers[currentQuestionIndex] || ''}">`;
                }
                
                optionsHTML += '</div>';
                
                container.innerHTML = questionHTML + optionsHTML;

                let countdown = 7;
                setTimeout(() => {
                    const countdownEl = document.getElementById('countdown');
                    const memoryStimulus = document.getElementById('memory-stimulus');
                    const memoryTask = document.getElementById('memory-task');
                    const optionsWrapper = document.getElementById('options-container-wrapper');
                    const textInput = document.getElementById(`text-input-${currentQuestionIndex}`);
                    const nextBtn = document.getElementById('next-btn');

                    const interval = setInterval(() => {
                        countdown--;
                        if(countdownEl) countdownEl.textContent = countdown;
                        if (countdown <= 0) {
                            clearInterval(interval);
                            if (memoryStimulus) memoryStimulus.style.display = 'none';
                            if (memoryTask) memoryTask.style.display = 'block';
                            if (optionsWrapper) optionsWrapper.style.display = 'flex';
                            
                            if (textInput) {
                                textInput.focus();
                                if (nextBtn) {
                                    nextBtn.disabled = !textInput.value.trim();
                                }
                                textInput.addEventListener('keyup', (e) => {
                                    app.test.state.userAnswers[currentQuestionIndex] = e.target.value.trim();
                                    if (nextBtn) {
                                        nextBtn.disabled = e.target.value.trim() === '';
                                    }
                                });
                            }
                        }
                    }, 1000);
                }, 100);
            };
            
            if (questionData.section === 3 && (currentTest.questions[currentQuestionIndex-1]?.section !== 3)) {
                app.ui.showCustomAlert("Perhatian! Bagian tes memori akan dimulai. Anda akan diberi waktu beberapa detik untuk menghafal informasi sebelum menjawab.", startMemoryCountdown);
            } else if (currentTest.testType === 'iq' && questionData.section === 3 && questionData.q.includes('Hafalkan:')) {
                startMemoryCountdown();
            } else {
                let questionHTML = `<p class="text-lg sm:text-xl mb-4 text-center">${questionData.q}</p>`;
                if (questionData.isVisual) {
                    if (questionData.visualQuestion) {
                        questionHTML += questionData.visualQuestion;
                    } else {
                        questionHTML += app.test.getVisualForQuestion(questionData);
                    }
                }
                
                const optionsToUse = questionData.options || currentTest.options;
                let optionsHTML = '';

                if (optionsToUse && optionsToUse[0].visual) {
                    optionsHTML = '<div class="flex flex-wrap justify-center items-center gap-4">';
                    optionsToUse.forEach((option, index) => {
                        const optionId = `q${currentQuestionIndex}_option${index}`;
                        const isChecked = userAnswers[currentQuestionIndex] === option.value;
                        optionsHTML += `
                            <div class="text-center">
                                <input type="radio" id="${optionId}" name="question_${currentQuestionIndex}" value="${option.value}" class="hidden peer" ${isChecked ? 'checked' : ''}>
                                <label for="${optionId}" class="block p-3 border-2 border-gray-200 rounded-lg cursor-pointer transition-all duration-200 peer-checked:border-indigo-600 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-indigo-500 hover:shadow-md hover:border-gray-400">
                                    ${option.visual}
                                    <p class="font-bold mt-2 text-gray-700">${option.value}</p>
                                </label>
                            </div>`;
                    });
                    optionsHTML += '</div>';
                } else if (optionsToUse) {
                    optionsHTML = '<div class="flex flex-col items-center space-y-3">';
                    let options = [...optionsToUse];
                    if (currentTest.name === 'Kognitif Premium') {
                        options.sort(() => Math.random() - 0.5);
                    }

                    options.forEach((option, index) => {
                        const optionValue = option.value !== undefined ? option.value : option;
                        const optionId = `q${currentQuestionIndex}_option${index}`;
                        const isChecked = userAnswers[currentQuestionIndex] !== undefined && String(userAnswers[currentQuestionIndex]) == String(optionValue);
                        optionsHTML += `
                            <div class="w-full max-w-md">
                                <input type="radio" id="${optionId}" name="question_${currentQuestionIndex}" value="${optionValue}" class="hidden peer" ${isChecked ? 'checked' : ''}>
                                <label for="${optionId}" class="block w-full text-center p-3 border border-gray-300 rounded-lg cursor-pointer peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 hover:bg-indigo-50">${option.text || option}</label>
                            </div>`;
                    });
                    optionsHTML += '</div>';
                }
                container.innerHTML = questionHTML + optionsHTML;
            }

            app.test.updateNavButtons();
        };

        app.test.renderRIASECPage = () => {
            const { currentTest, riasecCurrentPage, riasecQuestionsPerPage, userAnswers } = app.test.state;
            document.getElementById('test-title').textContent = currentTest.title;
            document.getElementById('test-section-title').textContent = '';
            
            const progressBarContainer = document.getElementById('progress-bar-container');
            progressBarContainer.innerHTML = `
                <div class="flex justify-between mb-1">
                    <span id="riasec-progress-text" class="text-base font-medium text-teal-700"></span>
                    <span id="riasec-progress-percentage" class="text-sm font-medium text-teal-700"></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="riasec-progress-bar-fill" class="bg-teal-600 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div>
                </div>`;

            const container = document.getElementById('question-container');
            container.innerHTML = '';
            
            const startIndex = (riasecCurrentPage - 1) * riasecQuestionsPerPage;
            const endIndex = startIndex + riasecQuestionsPerPage;
            const pageQuestions = currentTest.questions.slice(startIndex, endIndex);

            pageQuestions.forEach((q, index) => {
                const globalIndex = startIndex + index;
                const questionBlock = document.createElement('div');
                questionBlock.className = 'p-4 border-t';
                
                const questionText = document.createElement('p');
                questionText.className = 'font-semibold text-gray-700 mb-4 text-center';
                questionText.textContent = `${globalIndex + 1}. ${q.text}`;
                
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'flex items-center justify-center space-x-4';
                
                [{val: 1, label: 'Suka'}, {val: 0, label: 'Tidak Suka'}].forEach(opt => {
                    const optionId = `q_${q.originalIndex}_${opt.val}`;
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.id = optionId;
                    input.name = `q_${q.originalIndex}`;
                    input.value = opt.val === 1 ? 'suka' : 'tidak_suka';
                    input.dataset.originalIndex = q.originalIndex;
                    input.className = `hidden ${opt.val === 1 ? 'suka-radio' : 'tidaksuka-radio'}`;
                    if (userAnswers[q.originalIndex] === opt.val) input.checked = true;
                    
                    const label = document.createElement('label');
                    label.htmlFor = optionId;
                    label.textContent = opt.label;
                    label.className = `riasec-label w-32 text-center py-2 px-4 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full cursor-pointer`;
                    
                    optionsDiv.appendChild(input);
                    optionsDiv.appendChild(label);
                });
                questionBlock.appendChild(questionText);
                questionBlock.appendChild(optionsDiv);
                container.appendChild(questionBlock);
            });
            
            app.test.updateNavButtons();
            app.test.updateRIASECProgressBar();
            app.test.checkRIASECPageCompletion();
        };

        app.test.checkRIASECPageCompletion = () => {
            const { riasecCurrentPage, riasecQuestionsPerPage, currentTest, userAnswers } = app.test.state;
            const nextBtn = document.getElementById('next-btn');
            if (!nextBtn) return;

            const startIndex = (riasecCurrentPage - 1) * riasecQuestionsPerPage;
            const endIndex = startIndex + riasecQuestionsPerPage;
            const pageQuestions = currentTest.questions.slice(startIndex, endIndex);
            const allAnswered = pageQuestions.every(q => userAnswers[q.originalIndex] !== undefined);
            
            nextBtn.disabled = !allAnswered;
        };

        app.test.updateRIASECProgressBar = () => {
            const answeredCount = Object.keys(app.test.state.userAnswers).length;
            const totalQuestions = app.test.state.currentTest.questions.length;
            const progress = (answeredCount / totalQuestions) * 100;
            document.getElementById('riasec-progress-bar-fill').style.width = `${progress}%`;
            document.getElementById('riasec-progress-text').textContent = `Pertanyaan ${answeredCount} dari ${totalQuestions}`;
            document.getElementById('riasec-progress-percentage').textContent = `${Math.round(progress)}%`;
        };
        
        app.test.getVisualForQuestion = (question) => {
            const svgContainer = (svgContent, className = '') => `<div class="flex justify-center items-center my-4 p-4 bg-gray-100 rounded-lg ${className}">${svgContent}</div>`;
            let svg = '';
            switch (question.id) {
                case 25: svg = `<svg width="250" height="40" viewBox="0 0 250 40"><rect x="10" y="10" width="20" height="20" fill="#6366f1"/><circle cx="50" cy="20" r="10" fill="#6366f1"/><polygon points="70,30 80,10 90,30" fill="#6366f1"/><rect x="110" y="10" width="20" height="20" fill="#6366f1"/><circle cx="150" cy="20" r="10" fill="#6366f1"/><text x="170" y="25" font-size="20" fill="#9ca3af">?</text></svg>`; break;
                case 26: 
                    svg = `
                        <div class="flex flex-wrap justify-center gap-4">
                            <div class="text-center"><p class="font-bold">A</p><svg width="50" height="50"><g transform="translate(25, 25)"><circle r="20" stroke="black" fill="white" stroke-width="2"/><line x1="0" y1="0" x2="0" y2="-12" stroke="black" stroke-width="2"/><line x1="0" y1="0" x2="15" y2="0" stroke="black" stroke-width="1.5"/></g></svg></div>
                            <div class="text-center"><p class="font-bold">B</p><svg width="50" height="50"><g transform="translate(25, 25)"><circle r="20" stroke="black" fill="white" stroke-width="2"/><line x1="0" y1="0" x2="0" y2="-12" stroke="black" stroke-width="2"/><line x1="0" y1="0" x2="15" y2="0" stroke="black" stroke-width="1.5"/></g></svg></div>
                            <div class="text-center"><p class="font-bold">C</p><svg width="50" height="50"><g transform="translate(25, 25)"><circle r="20" stroke="black" fill="white" stroke-width="2"/><line x1="0" y1="0" x2="0" y2="-12" stroke="black" stroke-width="2"/><line x1="0" y1="0" x2="-15" y2="0" stroke="black" stroke-width="1.5"/></g></svg></div>
                            <div class="text-center"><p class="font-bold">D</p><svg width="50" height="50"><g transform="translate(25, 25)"><circle r="20" stroke="black" fill="white" stroke-width="2"/><line x1="0" y1="0" x2="0" y2="-12" stroke="black" stroke-width="2"/><line x1="0" y1="0" x2="15" y2="0" stroke="black" stroke-width="1.5"/></g></svg></div>
                            <div class="text-center"><p class="font-bold">E</p><svg width="50" height="50"><g transform="translate(25, 25)"><circle r="20" stroke="black" fill="white" stroke-width="2"/><line x1="0" y1="0" x2="0" y2="-12" stroke="black" stroke-width="2"/><line x1="0" y1="0" x2="15" y2="0" stroke="black" stroke-width="1.5"/></g></svg></div>
                        </div>`; 
                    return svgContainer(svg, 'w-full');
                case 27: svg = `<svg width="100" height="50" viewBox="0 0 100 50"><g transform="translate(25, 25)"><polygon points="0,-15 10,5 -10,5" fill="#6366f1"/></g><text x="45" y="30" font-size="20">→</text><text x="65" y="30" font-size="25" fill="#9ca3af">?</text></svg>`; break;
                case 28: svg = `<svg width="200" height="50" viewBox="0 0 200 50"><circle cx="25" cy="25" r="15" stroke="black" fill="none" stroke-width="2"/><text x="45" y="32">:</text><path d="M 65 40 A 15 15 0 0 1 95 40" stroke="black" fill="none" stroke-width="2"/><text x="105" y="32">::</text><rect x="125" y="10" width="30" height="30" stroke="black" fill="none" stroke-width="2"/><text x="160" y="32">:</text><text x="175" y="32" font-size="25" fill="#9ca3af">?</text></svg>`; break;
                case 31: svg = `<svg width="100" height="100" viewBox="0 0 100 100"><rect x="5" y="5" width="90" height="90" stroke="black" fill="white" stroke-width="2"/><line x1="5" y1="50" x2="95" y2="50" stroke="black" stroke-width="2"/><line x1="50" y1="5" x2="50" y2="95" stroke="black" stroke-width="2"/><line x1="5" y1="5" x2="95" y2="95" stroke="black" stroke-width="1"/></svg>`; break;
                case 34: svg = `<svg width="200" height="200" viewBox="0 0 100 100"><g stroke="#d1d5db" stroke-width="0.5"><line x1="10" y1="10" x2="90" y2="90" /><line x1="10" y1="90" x2="90" y2="10" /><line x1="50" y1="0" x2="50" y2="100" /><line x1="0" y1="50" x2="100" y2="50" /><line x1="0" y1="0" x2="100" y2="100" /><line x1="100" y1="0" x2="0" y2="100" /><circle cx="50" cy="50" r="40" fill="none" /><rect x="20" y="20" width="60" height="60" fill="none" /><line x1="20" y1="20" x2="80" y2="80" /><line x1="20" y1="80" x2="80" y2="20" /></g><polygon points="65,35 66,38 69,38 67,40 68,43 65,41 62,43 63,40 61,38 64,38" fill="#a1a1aa" /></svg>`; break;
                case 36: svg = `<svg width="250" height="50" viewBox="0 0 250 50"><g transform="translate(25, 25)"><circle r="20" stroke="black" fill="#fef08a" stroke-width="2"/><circle cx="-7" cy="-5" r="2"/><circle cx="7" cy="-5" r="2"/><path d="M -10 8 Q 0 15 10 8" stroke="black" fill="none" stroke-width="2"/></g><g transform="translate(75, 25)"><circle r="20" stroke="black" fill="#fef08a" stroke-width="2"/><circle cx="-7" cy="-5" r="2"/><circle cx="7" cy="-5" r="2"/><path d="M -10 8 Q 0 15 10 8" stroke="black" fill="none" stroke-width="2"/></g><g transform="translate(125, 25)"><circle r="20" stroke="black" fill="#fef08a" stroke-width="2"/><circle cx="-7" cy="-5" r="2"/><circle cx="7" cy="-5" r="2"/><path d="M -10 8 Q 0 15 10 8" stroke="black" fill="none" stroke-width="2"/><path d="M -12 -12 Q -7 -15 -2 -12" stroke="black" fill="none" stroke-width="1.5"/></g><g transform="translate(175, 25)"><circle r="20" stroke="black" fill="#fef08a" stroke-width="2"/><circle cx="-7" cy="-5" r="2"/><circle cx="7" cy="-5" r="2"/><path d="M -10 8 Q 0 15 10 8" stroke="black" fill="none" stroke-width="2"/></g><g transform="translate(225, 25)"><circle r="20" stroke="black" fill="#fef08a" stroke-width="2"/><circle cx="-7" cy="-5" r="2"/><circle cx="7" cy="-5" r="2"/><path d="M -10 8 Q 0 15 10 8" stroke="black" fill="none" stroke-width="2"/></g></svg>`; break;
                default: return '';
            }
            return svgContainer(svg);
        };

        app.test.updateNavButtons = () => {
            const { currentTest, currentQuestionIndex, riasecCurrentPage, riasecQuestionsPerPage } = app.test.state;
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');
            const progressText = document.getElementById('progress-text');
            
            if (currentTest.testType === 'riasec') {
                const totalPages = Math.ceil(currentTest.questions.length / riasecQuestionsPerPage);
                prevBtn.style.visibility = riasecCurrentPage > 1 ? 'visible' : 'hidden';
                nextBtn.style.display = riasecCurrentPage < totalPages ? 'inline-block' : 'none';
                submitBtn.style.display = riasecCurrentPage === totalPages ? 'inline-block' : 'none';
                progressText.textContent = `Halaman ${riasecCurrentPage} dari ${totalPages}`;
            } else {
                prevBtn.style.visibility = currentQuestionIndex > 0 ? 'visible' : 'hidden';
                nextBtn.style.display = currentQuestionIndex < currentTest.questions.length - 1 ? 'inline-block' : 'none';
                submitBtn.style.display = currentQuestionIndex === currentTest.questions.length - 1 ? 'inline-block' : 'none';
                progressText.textContent = `Soal ${currentQuestionIndex + 1} dari ${currentTest.questions.length}`;
            }
        };

        app.test.nextQuestion = () => {
            const { currentTest, currentQuestionIndex, userAnswers, riasecCurrentPage, riasecQuestionsPerPage } = app.test.state;
            
            if (currentTest.testType === 'riasec') {
                const totalPages = Math.ceil(currentTest.questions.length / riasecQuestionsPerPage);
                if (riasecCurrentPage < totalPages) {
                    app.test.state.riasecCurrentPage++;
                    app.test.renderRIASECPage();
                }
                return;
            }

            if (userAnswers[currentQuestionIndex] === undefined || userAnswers[currentQuestionIndex] === '') {
                // BUG FIX: Changed alert message to be more generic
                app.ui.showCustomAlert('Silakan isi jawaban terlebih dahulu.'); return;
            }
            if (currentQuestionIndex < currentTest.questions.length - 1) {
                app.test.state.currentQuestionIndex++;
                app.test.renderQuestion();
            }
        };

        app.test.prevQuestion = () => {
            if (app.test.state.currentTest.testType === 'riasec') {
                if (app.test.state.riasecCurrentPage > 1) {
                    app.test.state.riasecCurrentPage--;
                    app.test.renderRIASECPage();
                }
                return;
            }
            if (app.test.state.currentQuestionIndex > 0) {
                app.test.state.currentQuestionIndex--;
                app.test.renderQuestion();
            }
        };

        app.test.submitTest = () => {
            const { currentTest, userAnswers, currentQuestionIndex } = app.test.state;
            if (currentTest.testType === 'riasec') {
                 if (Object.keys(userAnswers).length < currentTest.questions.length) {
                    app.ui.showCustomAlert('Harap jawab semua pertanyaan sebelum melihat hasil.');
                    return;
                }
            } else if (currentTest.testType !== 'disc' && (userAnswers[currentQuestionIndex] === undefined || userAnswers[currentQuestionIndex] === '')) {
                app.ui.showCustomAlert('Silakan isi jawaban terlebih dahulu.'); return;
            }
            if (app.test.state.testTimerInterval) clearInterval(app.test.state.testTimerInterval);
            app.test.confirmAndAnalyze();
        };

        app.test.confirmAndAnalyze = () => {
            if (app.test.state.testTimerInterval) clearInterval(app.test.state.testTimerInterval);
            const resultsScreen = document.getElementById('results-screen');
            resultsScreen.innerHTML = `
                <button class="back-to-dashboard mb-6 text-indigo-600 hover:text-indigo-800"><i class="fas fa-arrow-left mr-2"></i>Kembali ke Dashboard</button>
                <div id="loading-indicator" class="text-center p-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-indigo-500"></i>
                    <p class="mt-4 text-gray-600">Kami sedang menganalisa jawaban Anda...</p>
                </div>
                <div id="results-content" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg hidden"></div>`;
            app.ui.showScreen('results-screen');
            app.test.processResultsAndGenerateAnalysis();
        };

        app.test.processResultsAndGenerateAnalysis = () => {
            const { currentTest, currentUser, userAnswers } = app.test.state;
            let resultsSummary = {};
            let promptText = `Anda adalah seorang konsultan psikologi. Pengguna bernama ${currentUser} telah menyelesaikan tes. Buat laporan psikologis yang profesional, tajam, dan bisa ditindaklanjuti dalam BAHASA INDONESIA. Gunakan format berikut untuk setiap judul bagian: [IKON:nama-ikon-fontawesome] Judul Bagian. Contoh: [IKON:fa-user-circle] Profil Umum. PENTING: Jangan gunakan karakter markdown seperti '*' atau '#'. Untuk menyorot informasi penting, apit teks dengan tag <u> dan </u>. Contoh: <u>Teks Penting</u>. Gunakan baris baru biasa untuk daftar. Di akhir laporan, tuliskan: "Laporan ini disusun oleh: Fajar, S.Psi". `;
            
            if (currentTest.name === 'Kognitif Premium') {
                let correctAnswers = 0;
                currentTest.questions.forEach((q, i) => {
                    const userAnswer = userAnswers[i];
                    let isCorrect = false;
                    if (q.options) {
                        const selectedOptionText = q.options.find(opt => (opt.value !== undefined ? opt.value : opt) == userAnswer) || userAnswer;
                        isCorrect = String(selectedOptionText).toLowerCase() === String(q.answer).toLowerCase();
                    } else {
                        if (Array.isArray(q.answer)) isCorrect = q.answer.some(ans => String(ans).toLowerCase().trim() === String(userAnswer).toLowerCase().trim());
                        else isCorrect = String(userAnswer || '').toLowerCase().replace(/[\s,.-]/g, '') === String(q.answer).toLowerCase().replace(/[\s,.-]/g, '');
                    }
                    if (isCorrect) correctAnswers++;
                });
                const totalQuestions = currentTest.questions.length;
                const iqScore = Math.round(70 + (correctAnswers / totalQuestions) * 90);
                const iqCategory = app.test.getIQCategory(iqScore);
                resultsSummary = { iqScore, iqCategory, correctAnswers, totalQuestions };
                promptText += `Pengguna mendapatkan skor IQ ${iqScore} (kategori: ${iqCategory}). Berikan analisis singkat tentang arti skor ini dan potensi implikasinya dalam format berikut: [IKON:fa-magnifying-glass-chart] Analisis Umum, [IKON:fa-rocket] Potensi Kekuatan, [IKON:fa-compass] Area Pengembangan.`;
            } else if (currentTest.name === 'Minat Bakat Premium') {
                const scores = { R: 0, I: 0, A: 0, S: 0, E: 0, C: 0 };
                currentTest.questions.forEach((q) => {
                    if (userAnswers[q.originalIndex] === 1) scores[q.type]++;
                });
                const sortedScores = Object.entries(scores).sort(([,a],[,b]) => b-a);
                const hollandCode = sortedScores.slice(0, 3).map(item => item[0]).join('');
                resultsSummary = { hollandCode: hollandCode, scores: scores };
                promptText += `Data hasil Tes Minat Bakat Holland (RIASEC) adalah Kode Holland: <u>${hollandCode}</u>. Buat bagian berikut: [IKON:fa-file-alt] Deskripsi Tipe Minat Dominan, [IKON:fa-building] Lingkungan Kerja Ideal, dan [IKON:fa-briefcase] Rekomendasi Karir Sesuai Minat.`;
            }

            app.test.callGeminiAPI(promptText, resultsSummary, app.test.displayResults, app.test.state.currentTest.name);
        };
        
        app.test.callGeminiAPI = async (prompt, results, callback, testKey = null) => {
            const nameForTest = testKey || app.test.state.currentTest.name;
            const apiKey = "AIzaSyDWCrd0lfmX75fPr11l74g7wgrnSi3PFhM"; 
            if (apiKey === "MASUKKAN_API_KEY_ANDA_DI_SINI") {
                const errorText = "API Key belum dimasukkan. Silakan edit file index.html dan masukkan API Key Anda.";
                app.test.displayResults({ analysis: errorText, summary: results, testName: nameForTest });
                return;
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("API Error Body:", errorBody);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorBody.error?.message || 'Unknown Error'}`);
                }
                const data = await response.json();
                const analysisText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, terjadi kesalahan saat AI menganalisis hasil.";
                const resultData = { summary: results, analysis: analysisText, date: new Date().toLocaleString('id-ID'), testName: nameForTest };
                
                if(results) { // Only save if it's a test result, not a career reco
                    app.test.state.savedResults[nameForTest] = resultData;
                    app.test.saveResultsToStorage();
                }
                callback(resultData);
            } catch (error) {
                console.error("Error calling Gemini API directly:", error);
                const errorText = `Terjadi masalah koneksi saat menghubungi AI. Pastikan Anda terhubung ke internet dan coba lagi. Error: ${error.message}`;
                callback({ analysis: errorText, summary: results, testName: nameForTest });
            }
        };

        app.test.displayResults = (resultData) => {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            
            const contentDiv = document.getElementById('results-content');
            const { testName, analysis, date } = resultData;

            if (testName === 'Kognitif Premium') {
                contentDiv.innerHTML = app.test.renderIQReport(resultData);
            } else {
                let formattedText = analysis
                    .replace(/\*\*(.*?)\*\*/g, '<u>$1</u>') // Replace **text** with <u>text</u>
                    .replace(/\*(.*?)\*/g, '<u>$1</u>')   // Replace *text* with <u>text</u>
                    .replace(/^#+\s/gm, '')              // Remove leading #
                    .replace(/\[IKON:(.*?)\]\s(.*?)\n/g, (match, icon, title) => {
                        return `<div class="flex items-center text-xl font-bold text-gray-800 mt-6 mb-3"><i class="fas ${icon.trim()} text-indigo-500 mr-3 w-6 text-center"></i><h3>${title.trim()}</h3></div>`;
                    })
                    .replace(/Laporan ini disusun oleh: Fajar, S.Psi/g, '<div class="mt-8 pt-4 border-t text-right text-sm text-gray-500"><em>Laporan ini disusun oleh:<br><strong>Fajar, S.Psi</strong></em></div>')
                    .replace(/\n/g, '<br>');
                let resultSummaryHTML = `<h2 class="text-2xl font-bold mb-1 text-center">Laporan Psikologis untuk ${app.test.state.currentUser}</h2><p class="text-center text-sm text-gray-500 mb-6">Tes: ${app.test.data.questions[testName].title} | Diselesaikan pada: ${date || 'Saat ini'}</p>`;
                contentDiv.innerHTML = resultSummaryHTML + `<div class="prose max-w-none">${formattedText}</div>`;
            }
            
            const downloadButton = document.createElement('button');
            downloadButton.innerHTML = `<i class="fas fa-download mr-2"></i>Unduh Sertifikat`;
            downloadButton.className = 'w-full mt-8 bg-blue-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-600 transition';
            downloadButton.onclick = () => app.test.generateCertificate(resultData);
            contentDiv.appendChild(downloadButton);

            contentDiv.classList.remove('hidden');
        };

        app.test.getIQCategory = (score) => {
            if (score < 70) return "Disabilitas Intelektual";
            if (score <= 79) return "Ambang Batas";
            if (score <= 89) return "Rata-rata Rendah";
            if (score <= 109) return "Rata-rata";
            if (score <= 119) return "Rata-rata Tinggi";
            if (score <= 129) return "Superior";
            return "Sangat Superior";
        };

        app.test.renderIQReport = (resultData) => {
            const { summary, analysis, date } = resultData;
            const { iqScore, iqCategory } = summary;

            const iqRanges = [
                { range: "< 70", category: "Disabilitas Intelektual" }, { range: "70-79", category: "Ambang Batas" },
                { range: "80-89", category: "Rata-rata Rendah" }, { range: "90-109", category: "Rata-rata" },
                { range: "110-119", category: "Rata-rata Tinggi" }, { range: "120-129", category: "Superior" },
                { range: "130+", category: "Sangat Superior" }
            ];

            let tableRows = iqRanges.map(item => {
                const isHighlight = item.category === iqCategory;
                return `<tr class="${isHighlight ? 'iq-table-highlight' : ''}">
                            <td class="px-6 py-3">${item.range}</td>
                            <td class="px-6 py-3">${item.category} ${isHighlight ? '(Posisi Anda)' : ''}</td>
                        </tr>`;
            }).join('');
            
            let analysisSections = analysis.split('[IKON:').slice(1).map(section => {
                const parts = section.split(']');
                const icon = parts[0];
                const contentParts = parts[1].split('\n');
                const title = contentParts[0].trim();
                const content = contentParts.slice(1).join('<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<u>$1</u>')
                    .replace(/\*(.*?)\*/g, '<u>$1</u>');

                return `
                    <details class="border-b" open>
                        <summary class="py-3 cursor-pointer flex justify-between items-center font-semibold text-gray-700">
                            <span class="flex items-center"><i class="fas ${icon.trim()} text-indigo-500 mr-3 w-5 text-center"></i>${title}</span>
                            <i class="fas fa-chevron-right accordion-arrow"></i>
                        </summary>
                        <div class="p-4 text-gray-600 bg-gray-50">
                            ${content}
                        </div>
                    </details>
                `;
            }).join('');

            return `
                <h2 class="text-2xl font-bold mb-1 text-center">Sertifikat Hasil Tes IQ</h2>
                <p class="text-center text-sm text-gray-500 mb-6">Nama Peserta: ${app.test.state.currentUser}</p>
                
                <div class="bg-indigo-50 border-l-4 border-indigo-500 p-6 rounded-r-lg text-center mb-6">
                    <p class="text-lg text-indigo-800">Skor IQ Anda:</p>
                    <p class="text-6xl font-bold text-indigo-900">${iqScore}</p>
                    <p class="text-lg text-indigo-800 mt-2">Kategori: ${iqCategory}</p>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-white uppercase bg-gray-700">
                            <tr><th scope="col" class="px-6 py-3">Rentang IQ</th><th scope="col" class="px-6 py-3">Kategori</th></tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>

                <div class="text-sm text-gray-600 mt-6 prose max-w-none">
                    <p>Tabel di atas menggambarkan klasifikasi IQ dalam populasi umum berdasarkan standar internasional.</p>
                    <p><strong>Skor IQ Anda adalah ${iqScore}</strong>, yang termasuk dalam kategori <strong>${iqCategory}</strong>.</p>
                    <div class="mt-4">${analysisSections}</div>
                    <p class="mt-4 text-xs italic">Nilai ini diperoleh berdasarkan performa Anda dalam mengerjakan soal visual setara standar Raven's APM. Tes ini mengukur kemampuan berpikir logis dan pola, bukan hasil akademis. Hasil ini hanya merupakan estimasi kognitif dan tidak dimaksudkan untuk diagnosis medis atau psikologis formal.</p>
                </div>
            `;
        };

        app.test.generateCertificate = (resultData) => {
            const { summary, testName, date } = resultData;
            document.getElementById('cert-user-name').textContent = app.test.state.currentUser;
            document.getElementById('cert-test-name').textContent = app.test.data.questions[testName].title;
            document.getElementById('cert-date').textContent = date.split(',')[0];
            
            const scoresContainer = document.getElementById('cert-scores');
            scoresContainer.innerHTML = '';
            let scoreHTML = '';

            switch (testName) {
                case 'Kognitif Premium':
                    scoreHTML = `<div class="text-center"><p class="text-lg">Skor IQ Anda:</p><p class="text-4xl font-bold text-indigo-700">${summary.iqScore}</p><p class="text-md">${summary.iqCategory}</p></div>`;
                    break;
                case 'Minat Bakat Premium':
                    scoreHTML = `<div class="text-center"><p class="text-lg">Kode Holland Anda:</p><p class="text-3xl font-bold text-indigo-700">${summary.hollandCode}</p></div>`;
                    break;
            }
            scoresContainer.innerHTML = scoreHTML;

            const validationUrl = `https://example.com/validate?user=${app.test.state.currentUser}&test=${testName}&date=${date}`;
            const qrCodeEl = document.getElementById('cert-qr-code');
            qrCodeEl.src = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(validationUrl)}`;
            
            qrCodeEl.onload = () => {
                const certElement = document.getElementById('certificate');
                html2canvas(certElement, { useCORS: true }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Sertifikat-${app.test.state.currentUser.replace(' ', '_')}-${testName.replace(' ', '_')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }).catch(err => {
                    console.error("html2canvas error:", err);
                    app.ui.showCustomAlert("Gagal membuat sertifikat. Silakan coba lagi.");
                });
            };
            qrCodeEl.onerror = () => app.ui.showCustomAlert("Gagal memuat QR Code untuk sertifikat.");
        };

        app.test.viewResult = (testName) => {
            const resultData = app.test.state.savedResults[testName];
            if (resultData) {
                const resultsScreen = document.getElementById('results-screen');
                resultsScreen.innerHTML = `
                    <button class="back-to-dashboard mb-6 text-indigo-600 hover:text-indigo-800"><i class="fas fa-arrow-left mr-2"></i>Kembali ke Dashboard</button>
                    <div id="results-content" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg"></div>`;
                app.ui.showScreen('results-screen');
                app.test.displayResults(resultData);
            }
        };
        
        app.test.showCareerRecommendation = () => {
            const screen = document.getElementById('career-reco-screen');
            screen.innerHTML = `<button class="back-to-dashboard mb-6 text-indigo-600 hover:text-indigo-800"><i class="fas fa-arrow-left mr-2"></i>Kembali</button><div id="career-loading-indicator" class="text-center p-8"><i class="fas fa-spinner fa-spin text-4xl text-indigo-500"></i><p class="mt-4 text-gray-600">Menganalisis profil komprehensif Anda...</p></div><div id="career-content" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg hidden"></div>`;
            app.ui.showScreen('career-reco-screen');

            const iqResult = app.test.state.savedResults['Kognitif Premium'].summary;
            const bakatResult = app.test.state.savedResults['Minat Bakat Premium'].summary;
            
            const prompt = `Anda adalah seorang konsultan karir ahli. Berdasarkan data psikologis pengguna bernama ${app.test.state.currentUser} ini: Skor IQ ${iqResult.iqScore} (Kategori: ${iqResult.iqCategory}) dan Kode Minat Holland ${bakatResult.hollandCode}, berikan analisis karir yang holistik dan terperinci dalam BAHASA INDONESIA. Buat bagian-bagian berikut: [IKON:fa-user-tie] Profil Karir Anda, [IKON:fa-lightbulb] Analisis Sinergi (bagaimana IQ dan Minat saling mendukung), dan [IKON:fa-ranking-star] 5 Rekomendasi Karir Teratas (jelaskan 'Mengapa Cocok' untuk setiap karir dengan menggabungkan kedua hasil tes). Gunakan format [IKON:nama-ikon] untuk setiap judul bagian. PENTING: Jangan gunakan karakter markdown seperti '*' atau '#'. Untuk menyorot informasi penting, apit teks dengan tag <u> dan </u>. Contoh: <u>Teks Penting</u>. Gunakan baris baru biasa untuk daftar. Di akhir laporan, tuliskan: "Laporan ini disusun oleh: Fajar, S.Psi".`;
            app.test.callGeminiAPI(prompt, null, app.test.displayCareerRecommendation, 'Rekomendasi Karir');
        };

        app.test.displayCareerRecommendation = (result) => {
            const loadingIndicator = document.getElementById('career-loading-indicator');
            if(loadingIndicator) loadingIndicator.style.display = 'none';
            const contentDiv = document.getElementById('career-content');
            
            let formattedText = result.analysis
                .replace(/\*\*(.*?)\*\*/g, '<u>$1</u>') // Replace **text** with <u>text</u>
                .replace(/\*(.*?)\*/g, '<u>$1</u>')   // Replace *text* with <u>text</u>
                .replace(/^#+\s/gm, '')              // Remove leading #
                .replace(/\[IKON:(.*?)\]\s(.*?)\n/g, (match, icon, title) => `<div class="flex items-center text-xl font-bold text-gray-800 mt-6 mb-3"><i class="fas ${icon.trim()} text-indigo-500 mr-3 w-6 text-center"></i><h3>${title.trim()}</h3></div>`)
                .replace(/Laporan ini disusun oleh: Fajar, S.Psi/g, '<div class="mt-8 pt-4 border-t text-right text-sm text-gray-500"><em>Laporan ini disusun oleh:<br><strong>Fajar, S.Psi</strong></em></div>')
                .replace(/\n/g, '<br>');

            contentDiv.innerHTML = `<h2 class="text-2xl font-bold mb-4 text-center">Rekomendasi Karir untuk ${app.test.state.currentUser}</h2><div class="prose max-w-none">${formattedText}</div>`;
            contentDiv.classList.remove('hidden');
        };
        
        app.test.loadAppData = () => {
            app.test.data.questions = JSON.parse(JSON.stringify(app.test.defaultTestsData));
            app.test.loadResultsFromStorage();
        };

        app.test.saveResultsToStorage = () => {
            localStorage.setItem(`savedResults_${app.test.state.currentUser}`, JSON.stringify(app.test.state.savedResults));
        };

        app.test.loadResultsFromStorage = () => {
            const resultsData = localStorage.getItem(`savedResults_${app.test.state.currentUser}`);
            app.test.state.savedResults = resultsData ? JSON.parse(resultsData) : {};
        };

        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
